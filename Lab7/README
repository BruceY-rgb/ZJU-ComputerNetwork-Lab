# Lab7 Socket通信实验

## 项目结构

```
Lab7_Socket/
├── include/
│   ├── protocol.h       # 通信协议定义
│   └── socket_wrapper.h # Socket封装
├── src/
│   └── server.cpp       # 服务端程序
│   └── client.cpp       # 客户端程序
├── build.sh             # 编译脚本
└── README.md
```

## 协议设计

### 数据包格式

采用固定头部 + 变长数据体结构:

```
+--------+--------+------------+----------+
| Type   | Length | Sequence   | Data     |
| 1 byte | 2 bytes| 4 bytes    | Variable |
+--------+--------+------------+----------+
```

- **Type**: 消息类型 (请求/响应/通知)
- **Length**: 数据部分长度 (网络字节序)
- **Sequence**: 序列号 (用于调试)
- **Data**: 变长数据

### 消息类型

**客户端请求 (0x0x)**
- 0x01: 连接请求
- 0x02: 断开连接
- 0x03: 获取时间
- 0x04: 获取服务器名称
- 0x05: 获取客户端列表
- 0x06: 发送消息

**服务端响应 (0x1x)**
- 0x11: 连接响应
- 0x12: 时间响应
- 0x13: 名称响应
- 0x14: 客户端列表响应
- 0x15: 发送结果响应

**服务端通知 (0x2x)**
- 0x21: 消息通知
- 0x22: 断开通知

## 编译和运行

### 编译

```bash
chmod +x build.sh
./build.sh
```

### 运行服务端

```bash
./server
```

服务端默认监听 8080 端口 (可在 server.cpp 中修改 SERVER_PORT)

### 运行客户端

```bash
./client
```

按照菜单提示操作:
1. 输入 1 连接服务器
2. 输入服务器 IP (默认 127.0.0.1)
3. 输入端口 (默认 8080)
4. 连接后可使用各种功能

### 测试多客户端

打开多个终端窗口,分别运行客户端程序

## 功能说明

### 服务端功能
- ✓ 支持多客户端并发连接
- ✓ 响应时间查询
- ✓ 响应服务器名称查询
- ✓ 响应客户端列表查询
- ✓ 优雅退出 (Ctrl+C)

### 客户端功能
- ✓ 连接/断开服务器
- ✓ 获取服务器时间
- ✓ 获取服务器名称
- ✓ 获取在线客户端列表
- ✓ 多线程消息处理
- ✓ 优雅退出 (Ctrl+C)

## 技术要点

1. **Socket封装**: 使用 SocketWrapper 类封装原生 Socket API
2. **协议设计**: 固定头部 + 变长数据,支持扩展
3. **序列化/反序列化**: 自动处理网络字节序转换
4. **多线程**: 服务端为每个客户端创建独立线程
5. **线程同步**: 使用 mutex 和 condition_variable 保护共享数据
6. **RAII**: 利用析构函数自动关闭 Socket

## 扩展功能 (可选)

如需添加消息转发功能,参考以下思路:

1. 在服务端添加消息转发处理
2. 客户端添加发送消息菜单项
3. 使用客户端列表编号选择目标
4. 服务端查找目标客户端并转发

## 注意事项

- Mac 系统编译时确保已安装 Xcode Command Line Tools
- 端口被占用时修改 SERVER_PORT 常量
- 使用 Ctrl+C 优雅退出,避免直接 kill
- 测试时建议使用 Wireshark 抓包观察协议