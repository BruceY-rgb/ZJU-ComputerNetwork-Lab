# Lab7 Socketé€šä¿¡å®éªŒ - æµ‹è¯•æŒ‡å—

## åŠŸèƒ½å®Œæˆæƒ…å†µ

âœ… **å·²å®ç°çš„åŠŸèƒ½ï¼š**
1. å®¢æˆ·ç«¯è¿æ¥/æ–­å¼€æœåŠ¡å™¨
2. è·å–æœåŠ¡å™¨æ—¶é—´
3. è·å–æœåŠ¡å™¨åç§°
4. è·å–åœ¨çº¿å®¢æˆ·ç«¯åˆ—è¡¨
5. **æ¶ˆæ¯è½¬å‘åŠŸèƒ½** ï¼ˆæ–°å¢ï¼‰
6. **æ‰¹é‡å‘é€100æ¬¡æ—¶é—´è¯·æ±‚** ï¼ˆæ–°å¢ï¼‰

## ç¼–è¯‘æ–¹æ³•

```bash
cd /Users/yangsmac/Desktop/Lab7
chmod +x build.sh
./build.sh
```

ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼š
- `server` - æœåŠ¡å™¨ç¨‹åº
- `client` - å®¢æˆ·ç«¯ç¨‹åº

## è¿è¡Œæ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡å™¨

```bash
./server
```

æœåŠ¡å™¨ä¼šç›‘å¬åœ¨ç«¯å£ **4703**ï¼ˆä½¿ç”¨å­¦å·å4ä½ï¼‰

### 2. å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆå¯å¯åŠ¨å¤šä¸ªï¼‰

```bash
./client
```

## åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•1ï¼šåŸºæœ¬è¿æ¥å’ŒæŸ¥è¯¢åŠŸèƒ½

1. å¯åŠ¨æœåŠ¡å™¨
2. å¯åŠ¨å®¢æˆ·ç«¯
3. é€‰æ‹© `1` è¿æ¥æœåŠ¡å™¨ï¼ˆé»˜è®¤127.0.0.1:4703ï¼‰
4. é€‰æ‹© `2` è·å–æ—¶é—´
5. é€‰æ‹© `3` è·å–æœåŠ¡å™¨åç§°
6. é€‰æ‹© `4` è·å–å®¢æˆ·ç«¯åˆ—è¡¨

### æµ‹è¯•2ï¼šæ¶ˆæ¯è½¬å‘åŠŸèƒ½

1. å¯åŠ¨1ä¸ªæœåŠ¡å™¨
2. å¯åŠ¨2ä¸ªæˆ–æ›´å¤šå®¢æˆ·ç«¯ï¼Œåˆ†åˆ«è¿æ¥åˆ°æœåŠ¡å™¨
3. åœ¨å®¢æˆ·ç«¯Aä¸­ï¼š
   - é€‰æ‹© `4` æŸ¥çœ‹å®¢æˆ·ç«¯åˆ—è¡¨ï¼Œè®°ä½å…¶ä»–å®¢æˆ·ç«¯çš„ç¼–å·
   - é€‰æ‹© `5` å‘é€æ¶ˆæ¯
   - è¾“å…¥ç›®æ ‡å®¢æˆ·ç«¯ç¼–å·ï¼ˆå¦‚ `2`ï¼‰
   - è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼ˆå¦‚ `Hello from Client A!`ï¼‰
4. è§‚å¯Ÿå®¢æˆ·ç«¯Bæ˜¯å¦æ”¶åˆ°æ¶ˆæ¯é€šçŸ¥

**é¢„æœŸç»“æœï¼š**
- å®¢æˆ·ç«¯Aæ˜¾ç¤ºï¼š`ğŸ“¤ [Send Result] Success: Message sent to xxx.xxx.xxx.xxx:xxxx`
- å®¢æˆ·ç«¯Bæ˜¾ç¤ºï¼š`ğŸ’¬ [New Message] From xxx.xxx.xxx.xxx:xxxx: Hello from Client A!`

### æµ‹è¯•3ï¼šæ‰¹é‡å‘é€100æ¬¡æ—¶é—´è¯·æ±‚

1. å¯åŠ¨æœåŠ¡å™¨
2. å¯åŠ¨å®¢æˆ·ç«¯å¹¶è¿æ¥
3. é€‰æ‹© `2` è·å–æ—¶é—´
4. è¾“å…¥ `y` é€‰æ‹©æ‰¹é‡æ¨¡å¼
5. è§‚å¯Ÿç»Ÿè®¡ç»“æœ

**é¢„æœŸè¾“å‡ºï¼š**
```
========== ç»Ÿè®¡ç»“æœ ==========
 å‘é€è¯·æ±‚æ•°: 100
 æ”¶åˆ°å“åº”æ•°: 100
 âœ“ æ‰€æœ‰å“åº”å‡å·²æ”¶åˆ°ï¼
=============================
```

**åŒæ—¶ä½¿ç”¨WiresharkæŠ“åŒ…ï¼š**
- è¿‡æ»¤å™¨ï¼š`tcp.port == 4703`
- è§‚å¯Ÿå®é™…TCP Segmentæ•°é‡ï¼ˆåº”è¯¥è¿œå°‘äº100ä¸ªï¼‰
- éªŒè¯TCPåˆå¹¶æœºåˆ¶

### æµ‹è¯•4ï¼šå¤šå®¢æˆ·ç«¯å¹¶å‘

1. å¯åŠ¨æœåŠ¡å™¨
2. åŒæ—¶å¯åŠ¨3-5ä¸ªå®¢æˆ·ç«¯
3. æ‰€æœ‰å®¢æˆ·ç«¯éƒ½é€‰æ‹©æ‰¹é‡å‘é€100æ¬¡è¯·æ±‚
4. è§‚å¯ŸæœåŠ¡å™¨æ˜¯å¦æ­£ç¡®å¤„ç†æ‰€æœ‰è¯·æ±‚
5. æ£€æŸ¥æ¯ä¸ªå®¢æˆ·ç«¯æ˜¯å¦éƒ½æ”¶åˆ°100ä¸ªå“åº”

### æµ‹è¯•5ï¼šå¼‚å¸¸æ–­å¼€æ£€æµ‹

1. å¯åŠ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯A
2. å®¢æˆ·ç«¯Aè¿æ¥åï¼Œæ‹”æ‰ç½‘çº¿ï¼ˆæˆ–ç›´æ¥killè¿›ç¨‹ï¼‰
3. å¯åŠ¨å®¢æˆ·ç«¯Bå¹¶è¿æ¥
4. å®¢æˆ·ç«¯Bé€‰æ‹© `4` æŸ¥çœ‹åˆ—è¡¨ï¼Œè§‚å¯Ÿå®¢æˆ·ç«¯Aæ˜¯å¦è¿˜åœ¨
5. å°è¯•ç»™å®¢æˆ·ç«¯Aå‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿç»“æœ

**é¢„æœŸç°è±¡ï¼š**
- å®¢æˆ·ç«¯Aä»åœ¨åˆ—è¡¨ä¸­ï¼ˆæœåŠ¡å™¨æœªæ£€æµ‹åˆ°æ–­å¼€ï¼‰
- å‘é€æ¶ˆæ¯æ—¶å¯èƒ½æ˜¾ç¤ºæˆåŠŸï¼Œä½†å®é™…æ— æ³•é€è¾¾
- è¯´æ˜éœ€è¦å®ç°Keep-Aliveæˆ–å¿ƒè·³æœºåˆ¶

## WiresharkæŠ“åŒ…è¦ç‚¹

### æ•è·è¿‡æ»¤å™¨
```
tcp port 4703
```

### æ˜¾ç¤ºè¿‡æ»¤å™¨ç¤ºä¾‹

**æŸ¥çœ‹æ—¶é—´è¯·æ±‚åŒ…ï¼š**
```
tcp.port == 4703 && tcp.payload[0] == 0x03
```

**æŸ¥çœ‹æ—¶é—´å“åº”åŒ…ï¼š**
```
tcp.port == 4703 && tcp.payload[0] == 0x12
```

**æŸ¥çœ‹æ¶ˆæ¯è½¬å‘è¯·æ±‚ï¼š**
```
tcp.port == 4703 && tcp.payload[0] == 0x06
```

**æŸ¥çœ‹æ¶ˆæ¯é€šçŸ¥ï¼š**
```
tcp.port == 4703 && tcp.payload[0] == 0x21
```

### åˆ†æè¦ç‚¹

1. **æ•°æ®åŒ…æ ¼å¼**
   - å±•å¼€TCP payload
   - ç¬¬1å­—èŠ‚ï¼šæ¶ˆæ¯ç±»å‹
   - ç¬¬2-3å­—èŠ‚ï¼šæ•°æ®é•¿åº¦ï¼ˆç½‘ç»œå­—èŠ‚åºï¼‰
   - ç¬¬4-7å­—èŠ‚ï¼šåºåˆ—å·
   - åç»­ï¼šæ•°æ®å†…å®¹

2. **TCPåˆå¹¶è§‚å¯Ÿ**
   - ç»Ÿè®¡æ€»çš„TCP Segmentæ•°
   - ä¸send()è°ƒç”¨æ¬¡æ•°å¯¹æ¯”
   - è§‚å¯Ÿå•ä¸ªSegmentåŒ…å«å¤šä¸ªåº”ç”¨å±‚åŒ…çš„æƒ…å†µ

3. **ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹**
   - è¿æ¥å»ºç«‹ï¼šSYN -> SYN+ACK -> ACK
   - è¿æ¥æ–­å¼€ï¼šFIN -> ACK -> FIN -> ACK
   - TIME_WAITçŠ¶æ€æŒç»­çº¦60ç§’

## ä»£ç å…³é”®ç‚¹

### å®¢æˆ·ç«¯å…³é”®ä»£ç 

**æ¶ˆæ¯è½¬å‘ï¼ˆclient.cpp:258-282ï¼‰ï¼š**
```cpp
case 5: { // å‘é€æ¶ˆæ¯
    std::cout << "è¯·è¾“å…¥ç›®æ ‡å®¢æˆ·ç«¯ç¼–å·: ";
    std::string targetIdStr;
    std::getline(std::cin, targetIdStr);

    std::cout << "è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯: ";
    std::string message;
    std::getline(std::cin, message);

    std::string payload = targetIdStr + "|" + message;
    clientSocket->send(Packet(MessageType::REQ_SEND_MSG, payload));
    break;
}
```

**æ‰¹é‡è¯·æ±‚ï¼ˆclient.cpp:263-306ï¼‰ï¼š**
```cpp
for (int i = 0; i < 100; i++) {
    clientSocket->send(Packet(MessageType::REQ_GET_TIME));
}
std::cout << "æ”¶åˆ°å“åº”æ•°: " << timeResponseCount << std::endl;
```

### æœåŠ¡ç«¯å…³é”®ä»£ç 

**æ¶ˆæ¯è½¬å‘ï¼ˆserver.cpp:121-185ï¼‰ï¼š**
```cpp
case MessageType::REQ_SEND_MSG: {
    // è§£æï¼šç¼–å·|æ¶ˆæ¯
    std::string data = request.data;
    size_t delimPos = data.find('|');
    std::string targetIdStr = data.substr(0, delimPos);
    std::string message = data.substr(delimPos + 1);

    // æŸ¥æ‰¾ç›®æ ‡å®¢æˆ·ç«¯socket
    int targetFd = ...;

    // å‘é€é€šçŸ¥
    Packet notifyPkt(MessageType::NOTIFY_MSG, "From " + clientAddr + ": " + message);
    ::send(targetFd, notifyPkt.serialize().c_str(), ...);
    break;
}
```

## å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘é”™è¯¯ "atomic not found"
**A:** ç¡®ä¿ä½¿ç”¨C++11æˆ–æ›´é«˜ç‰ˆæœ¬ç¼–è¯‘ï¼š
```bash
g++ -std=c++17 ...
```

### Q2: ç«¯å£è¢«å ç”¨
**A:** ä¿®æ”¹server.cppä¸­çš„SERVER_PORTå¸¸é‡ï¼Œæˆ–ç­‰å¾…60ç§’è®©TIME_WAITçŠ¶æ€è¶…æ—¶

### Q3: å®¢æˆ·ç«¯æ”¶ä¸åˆ°å®Œæ•´çš„100ä¸ªå“åº”
**A:** å¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆä¿®æ”¹sleep_forçš„ç§’æ•°ï¼‰ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œçŠ¶å†µ

### Q4: æ¶ˆæ¯è½¬å‘å¤±è´¥
**A:** ç¡®ä¿ç›®æ ‡å®¢æˆ·ç«¯ç¼–å·æ­£ç¡®ï¼Œä¸”ç›®æ ‡å®¢æˆ·ç«¯ä»åœ¨çº¿

## å®éªŒæŠ¥å‘Šæˆªå›¾å»ºè®®

1. **æœåŠ¡å™¨å¯åŠ¨ç•Œé¢** - æ˜¾ç¤ºASCIIè‰ºæœ¯å­—å’Œç›‘å¬ç«¯å£
2. **å®¢æˆ·ç«¯èœå•** - æ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½é€‰é¡¹
3. **æ—¶é—´æŸ¥è¯¢** - æ˜¾ç¤ºè¯·æ±‚å’Œå“åº”
4. **å®¢æˆ·ç«¯åˆ—è¡¨** - æ˜¾ç¤ºå¤šä¸ªåœ¨çº¿å®¢æˆ·ç«¯
5. **æ¶ˆæ¯è½¬å‘** - å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„æˆªå›¾
6. **æ‰¹é‡è¯·æ±‚ç»Ÿè®¡** - æ˜¾ç¤º100æ¬¡è¯·æ±‚çš„ç»Ÿè®¡ç»“æœ
7. **WiresharkæŠ“åŒ…** - æ ‡æ³¨åè®®å­—æ®µå’ŒTCPåˆå¹¶ç°è±¡
8. **netstatçŠ¶æ€** - æ˜¾ç¤ºTIME_WAITçŠ¶æ€

## æ€§èƒ½æ•°æ®å‚è€ƒ

- 100æ¬¡è¯·æ±‚å‘é€è€—æ—¶ï¼šçº¦ 5-20 ms
- 100æ¬¡å“åº”æ¥æ”¶è€—æ—¶ï¼šçº¦ 100-500 msï¼ˆå–å†³äºç½‘ç»œå»¶è¿Ÿï¼‰
- TCP Segmentæ•°é‡ï¼šçº¦ 3-15 ä¸ªï¼ˆå—Nagleç®—æ³•å½±å“ï¼‰
- å•ä¸ªæ•°æ®åŒ…å¤§å°ï¼š7-100 å­—èŠ‚ä¸ç­‰
