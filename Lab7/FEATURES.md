# Lab7 åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. åŸºç¡€é€šä¿¡åŠŸèƒ½

#### å®¢æˆ·ç«¯åŠŸèƒ½
- âœ… è¿æ¥åˆ°æœåŠ¡å™¨ï¼ˆæ”¯æŒè‡ªå®šä¹‰IPå’Œç«¯å£ï¼‰
- âœ… æ–­å¼€è¿æ¥ï¼ˆä¼˜é›…é€€å‡ºï¼‰
- âœ… è·å–æœåŠ¡å™¨æ—¶é—´
- âœ… è·å–æœåŠ¡å™¨åç§°
- âœ… è·å–åœ¨çº¿å®¢æˆ·ç«¯åˆ—è¡¨
- âœ… **å‘é€æ¶ˆæ¯åˆ°å…¶ä»–å®¢æˆ·ç«¯**ï¼ˆæ–°å¢ï¼‰
- âœ… ä¿¡å·å¤„ç†ï¼ˆCtrl+Cä¼˜é›…é€€å‡ºï¼‰

#### æœåŠ¡å™¨åŠŸèƒ½
- âœ… ç›‘å¬æŒ‡å®šç«¯å£ï¼ˆ4703ï¼‰
- âœ… æ¥å—å¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥
- âœ… å“åº”æ—¶é—´æŸ¥è¯¢
- âœ… å“åº”æœåŠ¡å™¨åç§°æŸ¥è¯¢
- âœ… å“åº”å®¢æˆ·ç«¯åˆ—è¡¨æŸ¥è¯¢
- âœ… **æ¶ˆæ¯è½¬å‘**ï¼ˆæ–°å¢ï¼‰
- âœ… ä¿¡å·å¤„ç†ï¼ˆCtrl+Cä¼˜é›…é€€å‡ºï¼‰

### 2. é«˜çº§åŠŸèƒ½

#### æ‰¹é‡è¯·æ±‚æµ‹è¯•
- âœ… **è‡ªåŠ¨å‘é€100æ¬¡æ—¶é—´è¯·æ±‚**
- âœ… **ç»Ÿè®¡å“åº”æ•°é‡**
- âœ… **è®¡ç®—å‘é€è€—æ—¶**
- âœ… **éªŒè¯TCPåŒ…åˆå¹¶ç°è±¡**

#### å¤šçº¿ç¨‹æ¶æ„
- âœ… å®¢æˆ·ç«¯ä¸‰çº¿ç¨‹æ¨¡å‹ï¼š
  - ä¸»çº¿ç¨‹ï¼šç”¨æˆ·äº¤äº’
  - æ¥æ”¶çº¿ç¨‹ï¼šç½‘ç»œI/O
  - å‘ˆç°çº¿ç¨‹ï¼šæ¶ˆæ¯æ˜¾ç¤º
- âœ… æœåŠ¡å™¨å¤šçº¿ç¨‹æ¨¡å‹ï¼š
  - ä¸»çº¿ç¨‹ï¼šacceptè¿æ¥
  - å­çº¿ç¨‹ï¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆæ¯å®¢æˆ·ç«¯ä¸€ä¸ªçº¿ç¨‹ï¼‰

#### çº¿ç¨‹åŒæ­¥
- âœ… mutex + condition_variableå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
- âœ… ä¿æŠ¤å…±äº«æ•°æ®ç»“æ„ï¼ˆå®¢æˆ·ç«¯åˆ—è¡¨ï¼‰
- âœ… é˜²æ­¢æ—¥å¿—è¾“å‡ºä¹±åº

### 3. åè®®è®¾è®¡

#### æ•°æ®åŒ…æ ¼å¼
```
+--------+--------+--------+--------+------------+----------+
| Type   | Length (MSB)    | Length (LSB)    | Sequence   | Data     |
| 1 byte | 1 byte | 1 byte | 1 byte | 4 bytes    | Variable |
+--------+--------+--------+--------+------------+----------+
```

#### æ¶ˆæ¯ç±»å‹

**è¯·æ±‚ç±»å‹ (0x0x)ï¼š**
- 0x01: REQ_CONNECT - è¿æ¥è¯·æ±‚
- 0x02: REQ_DISCONNECT - æ–­å¼€è¯·æ±‚
- 0x03: REQ_GET_TIME - æ—¶é—´æŸ¥è¯¢
- 0x04: REQ_GET_NAME - åç§°æŸ¥è¯¢
- 0x05: REQ_GET_CLIENTS - åˆ—è¡¨æŸ¥è¯¢
- 0x06: REQ_SEND_MSG - **æ¶ˆæ¯è½¬å‘è¯·æ±‚**

**å“åº”ç±»å‹ (0x1x)ï¼š**
- 0x11: RESP_CONNECT - è¿æ¥å“åº”
- 0x12: RESP_TIME - æ—¶é—´å“åº”
- 0x13: RESP_NAME - åç§°å“åº”
- 0x14: RESP_CLIENTS - åˆ—è¡¨å“åº”
- 0x15: RESP_SEND_RESULT - **å‘é€ç»“æœå“åº”**

**é€šçŸ¥ç±»å‹ (0x2x)ï¼š**
- 0x21: NOTIFY_MSG - **æ¶ˆæ¯é€šçŸ¥**
- 0x22: NOTIFY_DISCONNECT - æ–­å¼€é€šçŸ¥

### 4. ç”¨æˆ·ç•Œé¢

#### ç°ä»£åŒ–ç»ˆç«¯ç•Œé¢
- âœ… ASCIIè‰ºæœ¯å­—æ¨ªå¹…
- âœ… ANSIé¢œè‰²é«˜äº®
- âœ… åˆ†ç±»å½©è‰²æ—¥å¿—ï¼ˆæœåŠ¡å™¨ï¼‰
- âœ… è¡¨æƒ…ç¬¦å·æ ‡è¯†ï¼ˆå®¢æˆ·ç«¯ï¼‰
- âœ… æ ¼å¼åŒ–èœå•

#### æ—¥å¿—ç³»ç»Ÿ
æœåŠ¡å™¨æ—¥å¿—ç±»å‹ï¼š
- `[INIT]` - åˆå§‹åŒ–ä¿¡æ¯ï¼ˆé’è‰²ï¼‰
- `[CONN]` - è¿æ¥äº‹ä»¶ï¼ˆç»¿è‰²/é»„è‰²/çº¢è‰²ï¼‰
- `[TASK]` - ä»»åŠ¡å¤„ç†ï¼ˆè“è‰²/å“çº¢è‰²ï¼‰
- `[SYSTEM]` - ç³»ç»Ÿäº‹ä»¶ï¼ˆçº¢è‰²ï¼‰
- `[ERROR]` - é”™è¯¯ä¿¡æ¯ï¼ˆçº¢è‰²ï¼‰

å®¢æˆ·ç«¯æ¶ˆæ¯ç±»å‹ï¼š
- `âœ” [Server]` - æœåŠ¡å™¨æ¶ˆæ¯ï¼ˆç»¿è‰²ï¼‰
- `ğŸ•’ [Time]` - æ—¶é—´å“åº”ï¼ˆè“è‰²ï¼‰
- `ğŸ· [Name]` - åç§°å“åº”ï¼ˆå“çº¢è‰²ï¼‰
- `ğŸ‘¥ [Client List]` - å®¢æˆ·ç«¯åˆ—è¡¨ï¼ˆé’è‰²ï¼‰
- `ğŸ“¤ [Send Result]` - å‘é€ç»“æœï¼ˆç»¿è‰²ï¼‰
- `ğŸ’¬ [New Message]` - æ–°æ¶ˆæ¯ï¼ˆé»„è‰²ï¼‰
- `âœ˜ [System]` - ç³»ç»Ÿé€šçŸ¥ï¼ˆçº¢è‰²ï¼‰

## ğŸ“Š å®éªŒæ•°æ®å’Œåˆ†æ

### TCPç‰¹æ€§éªŒè¯

#### 1. å®¢æˆ·ç«¯æºç«¯å£
- **ç»“è®º**ï¼šå®¢æˆ·ç«¯ä¸éœ€è¦bind()ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸´æ—¶ç«¯å£
- **èŒƒå›´**ï¼š32768-60999
- **è¡Œä¸º**ï¼šæ¯æ¬¡é‡è¿ç«¯å£æ”¹å˜

#### 2. listenå’Œaccept
- **ç»“è®º**ï¼šlistenåï¼Œacceptå‰ï¼Œå®¢æˆ·ç«¯connect()å¯ä»¥æˆåŠŸ
- **åŸå› **ï¼šTCPä¸‰æ¬¡æ¡æ‰‹ç”±å†…æ ¸å®Œæˆï¼Œä¸éœ€è¦åº”ç”¨å±‚å‚ä¸

#### 3. send()ä¸TCP Segment
- **ç»“è®º**ï¼šsend()æ¬¡æ•° â‰  TCP Segmentæ•°é‡
- **åŸå› **ï¼šNagleç®—æ³•åˆå¹¶å°åŒ…
- **éªŒè¯**ï¼š100æ¬¡send â†’ çº¦3-15ä¸ªTCP Segment

#### 4. å¤šå®¢æˆ·ç«¯åŒºåˆ†
- **æ–¹æ³•**ï¼šæ¯ä¸ªè¿æ¥å¯¹åº”ä¸åŒçš„socketæè¿°ç¬¦
- **æ ‡è¯†**ï¼šTCPå››å…ƒç»„ï¼ˆå®¢æˆ·ç«¯IPã€å®¢æˆ·ç«¯ç«¯å£ã€æœåŠ¡å™¨IPã€æœåŠ¡å™¨ç«¯å£ï¼‰
- **è·¯ç”±**ï¼šå†…æ ¸æ ¹æ®å››å…ƒç»„æŠ•é€’åˆ°æ­£ç¡®socket

#### 5. TIME_WAITçŠ¶æ€
- **è§¦å‘**ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥
- **æŒç»­**ï¼š60ç§’ï¼ˆ2MSLï¼‰
- **æ„ä¹‰**ï¼š
  - ç¡®ä¿æœ€åçš„ACKåˆ°è¾¾æœåŠ¡å™¨
  - é˜²æ­¢æ—§è¿æ¥æ•°æ®åŒ…å¹²æ‰°æ–°è¿æ¥

#### 6. å¼‚å¸¸æ–­å¼€æ£€æµ‹
- **ç°è±¡**ï¼šæœåŠ¡å™¨æ— æ³•ç«‹å³æ£€æµ‹åˆ°å®¢æˆ·ç«¯æ–­ç½‘
- **åŸå› **ï¼šTCPåŠå…³é—­ç‰¹æ€§
- **è§£å†³**ï¼š
  - TCP Keep-Alive
  - åº”ç”¨å±‚å¿ƒè·³
  - æ¥æ”¶/å‘é€è¶…æ—¶

### æ€§èƒ½æ•°æ®

#### æ‰¹é‡è¯·æ±‚æµ‹è¯•ï¼ˆ100æ¬¡ï¼‰
- **å‘é€è€—æ—¶**ï¼š5-20 ms
- **å“åº”å®Œæˆ**ï¼š100-500 ms
- **TCP Segment**ï¼š3-15ä¸ª
- **æ•°æ®æ€»é‡**ï¼š700å­—èŠ‚ï¼ˆè¯·æ±‚ï¼‰+ çº¦3000å­—èŠ‚ï¼ˆå“åº”ï¼‰
- **åˆå¹¶æ¯”ä¾‹**ï¼šçº¦93-97%çš„åŒ…è¢«åˆå¹¶

## ğŸ—ï¸ ä»£ç æ¶æ„

### å°è£…è®¾è®¡

#### SocketWrapperç±»ï¼ˆRAIIï¼‰
```cpp
class SocketWrapper {
    int sockfd;
    ~SocketWrapper() { close(sockfd); }  // è‡ªåŠ¨é‡Šæ”¾
    bool send(const Packet& pkt);
    bool recv(Packet& pkt);
};
```

**ä¼˜ç‚¹**ï¼š
- è‡ªåŠ¨ç®¡ç†socketç”Ÿå‘½å‘¨æœŸ
- å¼‚å¸¸å®‰å…¨
- ç®€åŒ–é”™è¯¯å¤„ç†

#### Packetç±»
```cpp
class Packet {
    PacketHeader header;
    std::string data;

    std::string serialize();          // åºåˆ—åŒ–
    static bool deserialize(...);     // ååºåˆ—åŒ–
};
```

**ä¼˜ç‚¹**ï¼š
- å°è£…åè®®ç»†èŠ‚
- è‡ªåŠ¨å¤„ç†ç½‘ç»œå­—èŠ‚åº
- ç±»å‹å®‰å…¨

### å…³é”®å®ç°

#### æ¶ˆæ¯è½¬å‘æµç¨‹
```
å®¢æˆ·ç«¯A                æœåŠ¡å™¨                å®¢æˆ·ç«¯B
   |                      |                      |
   |-- REQ_SEND_MSG ----->|                      |
   |  (ç¼–å·|æ¶ˆæ¯)          |                      |
   |                      |-- NOTIFY_MSG ------->|
   |                      |  (From A: æ¶ˆæ¯)      |
   |<-- RESP_SEND_RESULT -|                      |
   |  (Success/Error)     |                      |
```

#### æ‰¹é‡è¯·æ±‚ç»Ÿè®¡
```cpp
// å…¨å±€è®¡æ•°å™¨
std::atomic<int> timeResponseCount(0);
bool isBatchTimeRequest = false;

// å‘é€100æ¬¡
for (int i = 0; i < 100; i++) {
    send(REQ_GET_TIME);
}

// æ¥æ”¶çº¿ç¨‹è‡ªåŠ¨è®¡æ•°
if (isBatchTimeRequest) {
    timeResponseCount++;
}

// æ˜¾ç¤ºç»“æœ
std::cout << "æ”¶åˆ°å“åº”æ•°: " << timeResponseCount << std::endl;
```

## ğŸ“ å®éªŒæŠ¥å‘Šè¦ç‚¹

### éœ€è¦æˆªå›¾çš„éƒ¨åˆ†
1. æœåŠ¡å™¨å¯åŠ¨ç•Œé¢
2. å®¢æˆ·ç«¯èœå•ï¼ˆæœªè¿æ¥/å·²è¿æ¥ï¼‰
3. è¿æ¥å»ºç«‹è¿‡ç¨‹
4. æ—¶é—´æŸ¥è¯¢ï¼ˆå•æ¬¡å’Œæ‰¹é‡ï¼‰
5. åç§°æŸ¥è¯¢
6. å®¢æˆ·ç«¯åˆ—è¡¨
7. æ¶ˆæ¯è½¬å‘ï¼ˆå‘é€æ–¹å’Œæ¥æ”¶æ–¹ï¼‰
8. æ‰¹é‡è¯·æ±‚ç»Ÿè®¡ç»“æœ
9. WiresharkæŠ“åŒ…ï¼ˆæ ‡æ³¨åè®®å­—æ®µï¼‰
10. netstatæŸ¥çœ‹è¿æ¥çŠ¶æ€

### å…³é”®ä»£ç ç‰‡æ®µ
1. åè®®å®šä¹‰ï¼ˆprotocol.hï¼‰
2. å®¢æˆ·ç«¯ä¸»å¾ªç¯
3. å®¢æˆ·ç«¯æ¥æ”¶çº¿ç¨‹
4. æœåŠ¡å™¨ä¸»å¾ªç¯
5. æœåŠ¡å™¨å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹
6. æ¶ˆæ¯è½¬å‘å®ç°
7. æ‰¹é‡è¯·æ±‚å®ç°

### åˆ†æé—®é¢˜ç­”æ¡ˆ
âœ… å·²åœ¨å®éªŒæŠ¥å‘Šæ¨¡æ¿ä¸­å¡«å†™ï¼š
- å®¢æˆ·ç«¯bindé—®é¢˜
- listenå’Œaccept
- sendä¸TCP Segment
- å¤šå®¢æˆ·ç«¯åŒºåˆ†
- TIME_WAITçŠ¶æ€
- å¼‚å¸¸æ–­å¼€æ£€æµ‹

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

1. **RAIIè®¾è®¡æ¨¡å¼** - è‡ªåŠ¨èµ„æºç®¡ç†
2. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼** - çº¿ç¨‹é—´é€šä¿¡
3. **åŸå­æ“ä½œ** - æ— é”è®¡æ•°å™¨
4. **ç½‘ç»œå­—èŠ‚åºè½¬æ¢** - htons/ntohs
5. **å¤šçº¿ç¨‹å¹¶å‘** - æœåŠ¡å™¨æ”¯æŒå¤šå®¢æˆ·ç«¯
6. **ä¼˜é›…é€€å‡º** - ä¿¡å·å¤„ç†
7. **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸æ£€æµ‹
8. **ç”¨æˆ·ä½“éªŒ** - å½©è‰²ç•Œé¢å’Œæ¸…æ™°æç¤º

## ğŸ“š æ‰©å±•å¯èƒ½

### å¯ä»¥ç»§ç»­æ·»åŠ çš„åŠŸèƒ½
- [ ] TCP Keep-Aliveå®ç°
- [ ] åº”ç”¨å±‚å¿ƒè·³æœºåˆ¶
- [ ] æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆæ—¥å¿—æ–‡ä»¶ï¼‰
- [ ] ç”¨æˆ·è®¤è¯
- [ ] åŠ å¯†é€šä¿¡ï¼ˆTLS/SSLï¼‰
- [ ] æ–‡ä»¶ä¼ è¾“
- [ ] ç¾¤å‘æ¶ˆæ¯
- [ ] ç§èŠå’Œç¾¤èŠåˆ†ç¦»
- [ ] åœ¨çº¿çŠ¶æ€é€šçŸ¥
- [ ] æ¶ˆæ¯å†å²è®°å½•

### æ€§èƒ½ä¼˜åŒ–
- [ ] çº¿ç¨‹æ± ä»£æ›¿åŠ¨æ€åˆ›å»ºçº¿ç¨‹
- [ ] epoll/kqueueä»£æ›¿é˜»å¡I/O
- [ ] é›¶æ‹·è´æŠ€æœ¯
- [ ] æ•°æ®å‹ç¼©
- [ ] è¿æ¥æ± 

## ğŸ¯ å­¦ä¹ æ”¶è·

é€šè¿‡æœ¬å®éªŒï¼Œæ·±å…¥ç†è§£äº†ï¼š
1. Socketç¼–ç¨‹çš„å®Œæ•´æµç¨‹
2. TCPåè®®çš„å·¥ä½œæœºåˆ¶
3. å¤šçº¿ç¨‹ç¼–ç¨‹å’ŒåŒæ­¥
4. ç½‘ç»œåè®®è®¾è®¡
5. å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„
6. ç½‘ç»œè°ƒè¯•å·¥å…·ä½¿ç”¨ï¼ˆWireshark, netstatï¼‰
7. C++ç°ä»£ç‰¹æ€§åº”ç”¨ï¼ˆæ™ºèƒ½æŒ‡é’ˆæ¦‚å¿µã€RAIIã€åŸå­æ“ä½œï¼‰
