<img src="Lab7/cover.jpg" alt="cover" style="zoom:43%;" />

<div align="left">
  <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè¯¾ç¨‹åç§°ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbspè®¡ç®—æœºç½‘ç»œ&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒåç§°ï¼š<u>&nbsp&nbsp&nbspåŸºäºSocketæ¥å£å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå§“&nbsp&nbsp&nbsp&nbspåï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbsp å§“å&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦&nbsp&nbsp&nbsp&nbspé™¢ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbspè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯å­¦é™¢&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspç³»ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbspè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspä¸“&nbsp&nbsp&nbsp&nbspä¸šï¼š<u>&nbsp&nbsp&nbspè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦&nbsp&nbsp&nbsp&nbspå·ï¼š<u>&nbsp&nbsp&nbspå­¦å·&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspæŒ‡å¯¼æ•™å¸ˆï¼š<u>&nbsp&nbsp&nbspé™†ç³»ç¾¤&nbsp&nbsp&nbsp</u>
  </font><br/><br/><br/>
    <center><font face="é»‘ä½“" size = 5>
    æŠ¥å‘Šæ—¥æœŸ: 2025å¹´æœˆæ—¥
  </font>
    </center>
</div>
<div STYLE="page-break-after: always;"></div>

<center>
    <font face="é»‘ä½“" size=5>
        <b>æµ™æ±Ÿå¤§å­¦å®éªŒæŠ¥å‘Š</b>
    </font><br/><br/><br/></center>
<div align="left">  
    <font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè¯¾ç¨‹åç§°ï¼š<u>&nbsp&nbsp&nbsp&nbspè®¡ç®—æœºç½‘ç»œ&nbsp&nbsp&nbsp</u>å®éªŒç±»å‹:<u>&nbsp&nbsp&nbsp&nbspç»¼åˆ&nbsp&nbsp&nbsp</u>
        </font><br/><br/>
    <font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒé¡¹ç›®åç§°:<u>&nbsp&nbsp&nbsp&nbsp Lab8:åŸºäºSocketæ¥å£å®ç°è‡ªå®šä¹‰åè®®é€šä¿¡
 &nbsp&nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦ç”Ÿå§“å:<u>&nbsp&nbsp  &nbsp</u>ä¸“ä¸š: <u>&nbsp&nbsp è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯&nbsp&nbsp</u>å­¦å·: <u>&nbsp&nbsp &nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspåŒç»„å­¦ç”Ÿå§“å:<u>&nbsp&nbsp&nbsp&nbsp  &nbsp&nbsp&nbsp</u>æŒ‡å¯¼è€å¸ˆ: <u>&nbsp&nbsp&nbsp&nbspé™†ç³»ç¾¤&nbsp&nbsp&nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒåœ°ç‚¹:<u>&nbsp&nbsp&nbspæ›¹å…‰å½ªè¥¿-304 &nbsp&nbsp&nbsp</u>å®éªŒæ—¥æœŸ: <u>&nbsp&nbsp 2025å¹´æœˆæ—¥&nbsp&nbsp</u>
    </font><br/></div>





## ä¸€ã€å®éªŒç›®çš„

-   å­¦ä¹ å¦‚ä½•è®¾è®¡ç½‘ç»œåº”ç”¨åè®®

-   æŒæ¡Socketç¼–ç¨‹æ¥å£ç¼–å†™åŸºæœ¬çš„ç½‘ç»œåº”ç”¨è½¯ä»¶



## äºŒã€å®éªŒå†…å®¹

æ ¹æ®è‡ªå®šä¹‰çš„åè®®è§„èŒƒï¼Œä½¿ç”¨Socketç¼–ç¨‹æ¥å£ç¼–å†™åŸºæœ¬çš„ç½‘ç»œåº”ç”¨è½¯ä»¶ã€‚

-   æŒæ¡Cè¯­è¨€å½¢å¼çš„Socketç¼–ç¨‹æ¥å£ç”¨æ³•ï¼Œèƒ½å¤Ÿæ­£ç¡®å‘é€å’Œæ¥æ”¶ç½‘ç»œæ•°æ®åŒ…

-   å¼€å‘ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®ç°äººæœºäº¤äº’ç•Œé¢å’Œä¸æœåŠ¡å™¨çš„é€šä¿¡

-   å¼€å‘ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œå®ç°å¹¶å‘å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚

-   ç¨‹åºç•Œé¢ä¸åšè¦æ±‚ï¼Œä½¿ç”¨å‘½ä»¤è¡Œæˆ–æœ€ç®€å•çš„çª—ä½“å³å¯

-   åŠŸèƒ½è¦æ±‚å¦‚ä¸‹ï¼š

1.  è¿è¾“å±‚åè®®é‡‡ç”¨TCP

2.  å®¢æˆ·ç«¯é‡‡ç”¨äº¤äº’èœå•å½¢å¼ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä»¥ä¸‹åŠŸèƒ½ï¼š

    a.  è¿æ¥ï¼šè¯·æ±‚è¿æ¥åˆ°æŒ‡å®šåœ°å€å’Œç«¯å£çš„æœåŠ¡ç«¯

    b.  æ–­å¼€è¿æ¥ï¼šæ–­å¼€ä¸æœåŠ¡ç«¯çš„è¿æ¥

    c.  è·å–æ—¶é—´: è¯·æ±‚æœåŠ¡ç«¯ç»™å‡ºå½“å‰æ—¶é—´

    d.  è·å–åå­—ï¼šè¯·æ±‚æœåŠ¡ç«¯ç»™å‡ºå…¶æœºå™¨çš„åç§°

    e.  æ´»åŠ¨è¿æ¥åˆ—è¡¨ï¼šè¯·æ±‚æœåŠ¡ç«¯ç»™å‡ºå½“å‰è¿æ¥çš„æ‰€æœ‰å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆç¼–å·ã€IPåœ°å€ã€ç«¯å£ç­‰ï¼‰

    f.  å‘æ¶ˆæ¯ï¼šè¯·æ±‚æœåŠ¡ç«¯æŠŠæ¶ˆæ¯è½¬å‘ç»™å¯¹åº”ç¼–å·çš„å®¢æˆ·ç«¯ï¼Œè¯¥å®¢æˆ·ç«¯æ”¶åˆ°åæ˜¾ç¤ºåœ¨å±å¹•ä¸Š

    g.  é€€å‡ºï¼šæ–­å¼€è¿æ¥å¹¶é€€å‡ºå®¢æˆ·ç«¯ç¨‹åº

3.  æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„æŒ‡ä»¤å®Œæˆç‰¹å®šä»»åŠ¡ï¼š

    a.  å‘å®¢æˆ·ç«¯ä¼ é€æœåŠ¡ç«¯æ‰€åœ¨æœºå™¨çš„å½“å‰æ—¶é—´

    b.  å‘å®¢æˆ·ç«¯ä¼ é€æœåŠ¡ç«¯æ‰€åœ¨æœºå™¨çš„åç§°

    c.  å‘å®¢æˆ·ç«¯ä¼ é€å½“å‰è¿æ¥çš„æ‰€æœ‰å®¢æˆ·ç«¯ä¿¡æ¯

    d.  å°†æŸå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å†…å®¹è½¬å‘ç»™æŒ‡å®šç¼–å·çš„å…¶ä»–å®¢æˆ·ç«¯

    e.  é‡‡ç”¨å¼‚æ­¥å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å¼ï¼Œæ­£ç¡®å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ï¼ŒåŒæ—¶å‘é€æ¶ˆæ¯çš„æƒ…å†µ

-   æ ¹æ®ä¸Šè¿°åŠŸèƒ½è¦æ±‚ï¼Œè®¾è®¡ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„åº”ç”¨é€šä¿¡åè®®

-   æœ¬å®éªŒæ¶‰åŠåˆ°ç½‘ç»œæ•°æ®åŒ…å‘é€éƒ¨åˆ†ä¸èƒ½ä½¿ç”¨ä»»ä½•çš„Socketå°è£…ç±»ï¼Œåªèƒ½ä½¿ç”¨æœ€åº•å±‚çš„Cè¯­è¨€å½¢å¼çš„Socket API
    
-   æœ¬å®éªŒå¯ç»„æˆå°ç»„ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯ç”±ä¸åŒäººæ¥å®Œæˆ



## ä¸‰ã€ä¸»è¦ä»ªå™¨è®¾å¤‡

-   è”ç½‘çš„PCæœºã€Wiresharkè½¯ä»¶

-   Visual Studio Codeã€gccç­‰C++é›†æˆå¼€å‘ç¯å¢ƒã€‚



## å››ã€æ“ä½œæ–¹æ³•ä¸å®éªŒæ­¥éª¤

-   è®¾è®¡è¯·æ±‚ã€æŒ‡ç¤ºï¼ˆæœåŠ¡å™¨ä¸»åŠ¨å‘ç»™å®¢æˆ·ç«¯çš„ï¼‰ã€å“åº”æ•°æ®åŒ…çš„æ ¼å¼ï¼Œè‡³å°‘è¦è€ƒè™‘å¦‚ä¸‹é—®é¢˜ï¼š

a)  å®šä¹‰ä¸¤ä¸ªæ•°æ®åŒ…çš„è¾¹ç•Œå¦‚ä½•è¯†åˆ«

b)  å®šä¹‰æ•°æ®åŒ…çš„è¯·æ±‚ã€æŒ‡ç¤ºã€å“åº”ç±»å‹å­—æ®µ

c)  å®šä¹‰æ•°æ®åŒ…çš„é•¿åº¦å­—æ®µæˆ–è€…ç»“å°¾æ ‡è®°

d)  å®šä¹‰æ•°æ®åŒ…å†…æ•°æ®å­—æ®µçš„æ ¼å¼ï¼ˆç‰¹åˆ«æ˜¯è€ƒè™‘å®¢æˆ·ç«¯åˆ—è¡¨æ•°æ®å¦‚ä½•è¡¨è¾¾ï¼‰

-   å°ç»„åˆ†å·¥ï¼š1äººè´Ÿè´£ç¼–å†™æœåŠ¡ç«¯ï¼Œ1äººè´Ÿè´£ç¼–å†™å®¢æˆ·ç«¯

-   å®¢æˆ·ç«¯ç¼–å†™æ­¥éª¤ï¼ˆ**éœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹æ¨¡å¼**ï¼‰

a)  è¿è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨`socket()`ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·socketå¥æŸ„

b)  ç¼–å†™ä¸€ä¸ªèœå•åŠŸèƒ½ï¼Œåˆ—å‡º7ä¸ªé€‰é¡¹

c)  ç­‰å¾…ç”¨æˆ·é€‰æ‹©

d)  æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œåšå‡ºç›¸åº”çš„åŠ¨ä½œï¼ˆæœªè¿æ¥æ—¶ï¼Œåªèƒ½é€‰è¿æ¥åŠŸèƒ½å’Œé€€å‡ºåŠŸèƒ½ï¼‰

1.  é€‰æ‹©è¿æ¥åŠŸèƒ½ï¼šè¯·ç”¨æˆ·è¾“å…¥æœåŠ¡å™¨IPå’Œç«¯å£ï¼Œç„¶åè°ƒç”¨`connect()`ï¼Œç­‰å¾…è¿”å›ç»“æœå¹¶æ‰“å°ã€‚è¿æ¥æˆåŠŸåè®¾ç½®è¿æ¥çŠ¶æ€ä¸ºå·²è¿æ¥ã€‚**ç„¶ååˆ›å»ºä¸€ä¸ªæ¥æ”¶æ•°æ®çš„å­çº¿ç¨‹ï¼Œå¾ªç¯è°ƒç”¨`receive()`ï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„å“åº”æ•°æ®åŒ…ï¼Œå°±é€šè¿‡çº¿ç¨‹é—´é€šä¿¡ï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼‰å‘é€ç»™ä¸»çº¿ç¨‹ï¼Œç„¶åç»§ç»­è°ƒç”¨`receive()`ï¼Œç›´è‡³æ”¶åˆ°ä¸»çº¿ç¨‹é€šçŸ¥é€€å‡ºã€‚**

2.  é€‰æ‹©æ–­å¼€åŠŸèƒ½ï¼šè°ƒç”¨`close()`ï¼Œå¹¶è®¾ç½®è¿æ¥çŠ¶æ€ä¸ºæœªè¿æ¥ã€‚é€šçŸ¥å¹¶ç­‰å¾…å­çº¿ç¨‹å…³é—­ã€‚

3.  é€‰æ‹©è·å–æ—¶é—´åŠŸèƒ½ï¼šç»„è£…è¯·æ±‚æ•°æ®åŒ…ï¼Œç±»å‹è®¾ç½®ä¸ºæ—¶é—´è¯·æ±‚ï¼Œç„¶åè°ƒç”¨`send()`å°†æ•°æ®å‘é€ç»™æœåŠ¡å™¨ï¼Œ**æ¥ç€ç­‰å¾…æ¥æ”¶æ•°æ®çš„å­çº¿ç¨‹è¿”å›ç»“æœ**ï¼Œå¹¶æ ¹æ®å“åº”æ•°æ®åŒ…çš„å†…å®¹ï¼Œæ‰“å°æ—¶é—´ä¿¡æ¯ã€‚

4.  é€‰æ‹©è·å–åå­—åŠŸèƒ½ï¼šç»„è£…è¯·æ±‚æ•°æ®åŒ…ï¼Œç±»å‹è®¾ç½®ä¸ºåå­—è¯·æ±‚ï¼Œç„¶åè°ƒç”¨`send()`å°†æ•°æ®å‘é€ç»™æœåŠ¡å™¨ï¼Œæ¥ç€ç­‰å¾…æ¥æ”¶æ•°æ®çš„å­çº¿ç¨‹è¿”å›ç»“æœï¼Œå¹¶æ ¹æ®å“åº”æ•°æ®åŒ…çš„å†…å®¹ï¼Œæ‰“å°åå­—ä¿¡æ¯ã€‚

5.  é€‰æ‹©è·å–å®¢æˆ·ç«¯åˆ—è¡¨åŠŸèƒ½ï¼šç»„è£…è¯·æ±‚æ•°æ®åŒ…ï¼Œç±»å‹è®¾ç½®ä¸ºåˆ—è¡¨è¯·æ±‚ï¼Œç„¶åè°ƒç”¨`send()`å°†æ•°æ®å‘é€ç»™æœåŠ¡å™¨ï¼Œæ¥ç€ç­‰å¾…æ¥æ”¶æ•°æ®çš„å­çº¿ç¨‹è¿”å›ç»“æœï¼Œå¹¶æ ¹æ®å“åº”æ•°æ®åŒ…çš„å†…å®¹ï¼Œæ‰“å°å®¢æˆ·ç«¯åˆ—è¡¨ä¿¡æ¯ï¼ˆç¼–å·ã€IPåœ°å€ã€ç«¯å£ç­‰ï¼‰ã€‚

6.  é€‰æ‹©å‘é€æ¶ˆæ¯åŠŸèƒ½ï¼ˆé€‰æ‹©å‰éœ€è¦å…ˆè·å¾—å®¢æˆ·ç«¯åˆ—è¡¨ï¼‰ï¼šè¯·ç”¨æˆ·è¾“å…¥å®¢æˆ·ç«¯çš„åˆ—è¡¨ç¼–å·å’Œè¦å‘é€çš„å†…å®¹ï¼Œç„¶åç»„è£…è¯·æ±‚æ•°æ®åŒ…ï¼Œç±»å‹è®¾ç½®ä¸ºæ¶ˆæ¯è¯·æ±‚ï¼Œç„¶åè°ƒç”¨`send()`å°†æ•°æ®å‘é€ç»™æœåŠ¡å™¨ï¼Œæ¥ç€ç­‰å¾…æ¥æ”¶æ•°æ®çš„å­çº¿ç¨‹è¿”å›ç»“æœï¼Œå¹¶æ ¹æ®å“åº”æ•°æ®åŒ…çš„å†…å®¹ï¼Œæ‰“å°æ¶ˆæ¯å‘é€ç»“æœï¼ˆæ˜¯å¦æˆåŠŸé€è¾¾å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼‰ã€‚

7.  é€‰æ‹©é€€å‡ºåŠŸèƒ½ï¼šåˆ¤æ–­è¿æ¥çŠ¶æ€æ˜¯å¦ä¸ºå·²è¿æ¥ï¼Œæ˜¯åˆ™å…ˆè°ƒç”¨æ–­å¼€åŠŸèƒ½ï¼Œç„¶åå†é€€å‡ºç¨‹åºã€‚å¦åˆ™ï¼Œç›´æ¥é€€å‡ºç¨‹åºã€‚

8.  ä¸»çº¿ç¨‹é™¤äº†åœ¨ç­‰å¾…ç”¨æˆ·çš„è¾“å…¥å¤–ï¼Œè¿˜åœ¨å¤„ç†å­çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰æ¶ˆæ¯åˆ°è¾¾ï¼Œåˆ™è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ˜¯å“åº”æ¶ˆæ¯ï¼Œåˆ™æ‰“å°å“åº”æ¶ˆæ¯çš„æ•°æ®å†…å®¹ï¼ˆæ¯”å¦‚æ—¶é—´ã€åå­—ã€å®¢æˆ·ç«¯åˆ—è¡¨ç­‰ï¼‰ï¼›å¦‚æœæ˜¯æŒ‡ç¤ºæ¶ˆæ¯ï¼Œåˆ™æ‰“å°æŒ‡ç¤ºæ¶ˆæ¯çš„å†…å®¹ï¼ˆæ¯”å¦‚æœåŠ¡å™¨è½¬å‘çš„åˆ«çš„å®¢æˆ·ç«¯çš„æ¶ˆæ¯å†…å®¹ã€å‘é€è€…ç¼–å·ã€IPåœ°å€ã€ç«¯å£ç­‰ï¼‰ã€‚

-   æœåŠ¡ç«¯ç¼–å†™æ­¥éª¤ï¼ˆ**éœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹æ¨¡å¼**ï¼‰

a)  è¿è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨`socket()`ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·socketå¥æŸ„

b)  è°ƒç”¨`bind()`ï¼Œç»‘å®šç›‘å¬ç«¯å£ï¼ˆ**è¯·ä½¿ç”¨å­¦å·çš„å4ä½ä½œä¸ºæœåŠ¡å™¨çš„ç›‘å¬ç«¯å£**ï¼‰ï¼Œæ¥ç€è°ƒç”¨`listen()`ï¼Œè®¾ç½®è¿æ¥ç­‰å¾…é˜Ÿåˆ—é•¿åº¦

c)  ä¸»çº¿ç¨‹å¾ªç¯è°ƒç”¨`accept()`ï¼Œç›´åˆ°è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„socketå¥æŸ„ï¼Œåœ¨å®¢æˆ·ç«¯åˆ—è¡¨ä¸­å¢åŠ ä¸€ä¸ªæ–°å®¢æˆ·ç«¯çš„é¡¹ç›®ï¼Œå¹¶è®°å½•ä¸‹è¯¥å®¢æˆ·ç«¯å¥æŸ„å’Œè¿æ¥çŠ¶æ€ã€ç«¯å£ã€‚ç„¶ååˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹åç»§ç»­è°ƒç”¨`accept()`ã€‚è¯¥å­çº¿ç¨‹çš„ä¸»è¦æ­¥éª¤æ˜¯ï¼ˆ**åˆšè·å¾—çš„å¥æŸ„è¦ä¼ é€’ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹å†…éƒ¨è¦ä½¿ç”¨è¯¥å¥æŸ„å‘é€å’Œæ¥æ”¶æ•°æ®**ï¼‰ï¼š

-   è°ƒç”¨`send()`ï¼Œå‘é€ä¸€ä¸ªhelloæ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼ˆå¯é€‰ï¼‰

-   å¾ªç¯è°ƒç”¨`receive()`ï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚æ•°æ®åŒ…ï¼Œæ ¹æ®è¯·æ±‚ç±»å‹åšç›¸åº”çš„åŠ¨ä½œï¼š

1.  è¯·æ±‚ç±»å‹ä¸ºè·å–æ—¶é—´ï¼šè°ƒç”¨`time()`è·å–æœ¬åœ°æ—¶é—´ï¼Œç„¶åå°†æ—¶é—´æ•°æ®ç»„è£…è¿›å“åº”æ•°æ®åŒ…ï¼Œè°ƒç”¨`send()`å‘ç»™å®¢æˆ·ç«¯

2.  è¯·æ±‚ç±»å‹ä¸ºè·å–åå­—ï¼šå°†æœåŠ¡å™¨çš„åå­—ç»„è£…è¿›å“åº”æ•°æ®åŒ…ï¼Œè°ƒç”¨`send()`å‘ç»™å®¢æˆ·ç«¯

3.  è¯·æ±‚ç±»å‹ä¸ºè·å–å®¢æˆ·ç«¯åˆ—è¡¨ï¼šè¯»å–å®¢æˆ·ç«¯åˆ—è¡¨æ•°æ®ï¼Œå°†ç¼–å·ã€IPåœ°å€ã€ç«¯å£ç­‰æ•°æ®ç»„è£…è¿›å“åº”æ•°æ®åŒ…ï¼Œè°ƒç”¨`send()`å‘ç»™å®¢æˆ·ç«¯

4.  è¯·æ±‚ç±»å‹ä¸ºå‘é€æ¶ˆæ¯ï¼šæ ¹æ®ç¼–å·è¯»å–å®¢æˆ·ç«¯åˆ—è¡¨æ•°æ®ï¼Œå¦‚æœç¼–å·ä¸å­˜åœ¨ï¼Œå°†é”™è¯¯ä»£ç å’Œå‡ºé”™æè¿°ä¿¡æ¯ç»„è£…è¿›å“åº”æ•°æ®åŒ…ï¼Œè°ƒç”¨`send()`å‘å›æºå®¢æˆ·ç«¯ï¼›å¦‚æœç¼–å·å­˜åœ¨å¹¶ä¸”çŠ¶æ€æ˜¯å·²è¿æ¥ï¼Œåˆ™å°†è¦è½¬å‘çš„æ¶ˆæ¯ç»„è£…è¿›æŒ‡ç¤ºæ•°æ®åŒ…ã€‚è°ƒç”¨`send()`å‘ç»™æ¥æ”¶å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨æ¥æ”¶å®¢æˆ·ç«¯çš„socketå¥æŸ„ï¼‰ï¼Œå‘é€æˆåŠŸåç»„è£…è½¬å‘æˆåŠŸçš„å“åº”æ•°æ®åŒ…ï¼Œè°ƒç”¨`send()`å‘å›æºå®¢æˆ·ç«¯ã€‚

d)  ä¸»çº¿ç¨‹è¿˜è´Ÿè´£æ£€æµ‹é€€å‡ºæŒ‡ä»¤ï¼ˆå¦‚ç”¨æˆ·æŒ‰é€€å‡ºé”®æˆ–è€…æ”¶åˆ°é€€å‡ºä¿¡å·ï¼‰ï¼Œæ£€æµ‹åˆ°åå³é€šçŸ¥å¹¶ç­‰å¾…å„å­çº¿ç¨‹é€€å‡ºã€‚æœ€åå…³é—­Socketï¼Œä¸»ç¨‹åºé€€å‡ºã€‚

-   ç¼–ç¨‹ç»“æŸåï¼ŒåŒæ–¹ç¨‹åºè¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦å®ç°åŠŸèƒ½è¦æ±‚ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼ŒæŸ¥æ‰¾åŸå› ï¼Œå¹¶ä¿®æ”¹ï¼Œç›´è‡³æ»¡è¶³åŠŸèƒ½è¦æ±‚

-   ä½¿ç”¨å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥æœåŠ¡ç«¯ï¼Œæ£€æŸ¥å¹¶å‘æ€§

-   ä½¿ç”¨WiresharkæŠ“å–æ¯ä¸ªåŠŸèƒ½çš„äº¤äº’æ•°æ®åŒ…



## äº”ã€å®éªŒæ•°æ®è®°å½•å’Œå¤„ç†

!!! note
    >
    > * ä»¥ä¸‹å®éªŒè®°å½•å‡éœ€ç»“åˆå±å¹•æˆªå›¾ï¼ˆæˆªå–æºä»£ç æˆ–è¿è¡Œç»“æœï¼‰ï¼Œè¿›è¡Œæ–‡å­—æ ‡æ³¨å’Œæè¿°ã€‚
    >
    > * é€‰æ‹©ç«¯å£æ—¶ï¼Œè¯·ä½¿ç”¨å­¦å·å4ä½ï¼Œå¦‚åå››ä½ä¸­ç¬¬ä¸€ä½ä¸º0ï¼Œåˆ™åœ¨æœ€å‰æ·»åŠ 1
    >
    > * è¯·å°†ä»¥ä¸‹å†…å®¹å’Œæœ¬å®éªŒæŠ¥å‘Šä¸€èµ·æ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸Šä¼ ï¼š
    >
    >   -   æºä»£ç ï¼šéœ€è¦è¯´æ˜ç¼–è¯‘ç¯å¢ƒå’Œç¼–è¯‘æ–¹æ³•ï¼Œå¦‚æœä¸èƒ½ç¼–è¯‘æˆåŠŸï¼Œå°†å½±å“è¯„åˆ†
    >
    >
    >   -   å¯æ‰§è¡Œæ–‡ä»¶ï¼šå¯è¿è¡Œçš„.exeæ–‡ä»¶æˆ–Linuxå¯æ‰§è¡Œæ–‡ä»¶

- æè¿°è¯·æ±‚æ•°æ®åŒ…çš„æ ¼å¼ï¼ˆç”»å›¾è¯´æ˜ï¼‰ï¼Œè¯·æ±‚ç±»å‹çš„å®šä¹‰

  **æ•°æ®åŒ…æ ¼å¼ï¼š**

  ```
  +--------+--------+--------+--------+------------+----------+
  | Type   | Length (MSB)    | Length (LSB)    | Sequence (4 bytes)   | Data     |
  | 1 byte | 1 byte | 1 byte | 1 byte | 4 bytes    | Variable |
  +--------+--------+--------+--------+------------+----------+
  |<------- å›ºå®šå¤´éƒ¨ 7 bytes -------->|<-- å˜é•¿æ•°æ®ä½“ -->|
  ```

  **å­—æ®µè¯´æ˜ï¼š**
  - Type (1å­—èŠ‚): æ¶ˆæ¯ç±»å‹æ ‡è¯†
  - Length (2å­—èŠ‚): æ•°æ®éƒ¨åˆ†é•¿åº¦ï¼Œé‡‡ç”¨ç½‘ç»œå­—èŠ‚åº(å¤§ç«¯åº)
  - Sequence (4å­—èŠ‚): åºåˆ—å·ï¼Œç”¨äºè°ƒè¯•å’Œæ¶ˆæ¯è·Ÿè¸ª
  - Data (å¯å˜é•¿): å®é™…æ‰¿è½½çš„æ•°æ®å†…å®¹

  **è¯·æ±‚ç±»å‹å®šä¹‰(0x0xç³»åˆ—)ï¼š**
  - `0x01`: REQ_CONNECT - è¿æ¥è¯·æ±‚
  - `0x02`: REQ_DISCONNECT - æ–­å¼€è¿æ¥è¯·æ±‚
  - `0x03`: REQ_GET_TIME - è·å–æœåŠ¡å™¨æ—¶é—´è¯·æ±‚
  - `0x04`: REQ_GET_NAME - è·å–æœåŠ¡å™¨åç§°è¯·æ±‚
  - `0x05`: REQ_GET_CLIENTS - è·å–å®¢æˆ·ç«¯åˆ—è¡¨è¯·æ±‚
  - `0x06`: REQ_SEND_MSG - å‘é€æ¶ˆæ¯è¯·æ±‚(ç”¨äºæ¶ˆæ¯è½¬å‘)



- æè¿°å“åº”æ•°æ®åŒ…çš„æ ¼å¼ï¼ˆç”»å›¾è¯´æ˜ï¼‰ï¼Œå“åº”ç±»å‹çš„å®šä¹‰

  **æ•°æ®åŒ…æ ¼å¼ï¼š**

  å“åº”æ•°æ®åŒ…é‡‡ç”¨ä¸è¯·æ±‚ç›¸åŒçš„æ ¼å¼ç»“æ„ï¼š
  ```
  +--------+--------+--------+--------+------------+----------+
  | Type   | Length (MSB)    | Length (LSB)    | Sequence (4 bytes)   | Data     |
  | 1 byte | 1 byte | 1 byte | 1 byte | 4 bytes    | Variable |
  +--------+--------+--------+--------+------------+----------+
  ```

  **å“åº”ç±»å‹å®šä¹‰(0x1xç³»åˆ—)ï¼š**
  - `0x11`: RESP_CONNECT - è¿æ¥å“åº”ï¼ŒDataå­—æ®µåŒ…å«æ¬¢è¿æ¶ˆæ¯
  - `0x12`: RESP_TIME - æ—¶é—´å“åº”ï¼ŒDataå­—æ®µåŒ…å«æœåŠ¡å™¨å½“å‰æ—¶é—´å­—ç¬¦ä¸²
  - `0x13`: RESP_NAME - åç§°å“åº”ï¼ŒDataå­—æ®µåŒ…å«æœåŠ¡å™¨åç§°
  - `0x14`: RESP_CLIENTS - å®¢æˆ·ç«¯åˆ—è¡¨å“åº”ï¼ŒDataå­—æ®µåŒ…å«æ ¼å¼åŒ–çš„å®¢æˆ·ç«¯åˆ—è¡¨
  - `0x15`: RESP_SEND_RESULT - æ¶ˆæ¯å‘é€ç»“æœå“åº”ï¼ŒDataå­—æ®µåŒ…å«å‘é€æˆåŠŸ/å¤±è´¥çš„ä¿¡æ¯



- æè¿°æŒ‡ç¤ºæ•°æ®åŒ…çš„æ ¼å¼ï¼ˆç”»å›¾è¯´æ˜ï¼‰ï¼ŒæŒ‡ç¤ºç±»å‹çš„å®šä¹‰

  **æ•°æ®åŒ…æ ¼å¼ï¼š**

  æŒ‡ç¤ºæ•°æ®åŒ…é‡‡ç”¨ä¸è¯·æ±‚ã€å“åº”ç›¸åŒçš„æ ¼å¼ç»“æ„ï¼š
  ```
  +--------+--------+--------+--------+------------+----------+
  | Type   | Length (MSB)    | Length (LSB)    | Sequence (4 bytes)   | Data     |
  | 1 byte | 1 byte | 1 byte | 1 byte | 4 bytes    | Variable |
  +--------+--------+--------+--------+------------+----------+
  ```

  **æŒ‡ç¤ºç±»å‹å®šä¹‰(0x2xç³»åˆ—)ï¼š**
  - `0x21`: NOTIFY_MSG - æ¶ˆæ¯é€šçŸ¥ï¼ŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€è½¬å‘çš„æ¶ˆæ¯ç»™ç›®æ ‡å®¢æˆ·ç«¯
  - `0x22`: NOTIFY_DISCONNECT - æ–­å¼€é€šçŸ¥ï¼ŒæœåŠ¡å™¨ä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯å³å°†æ–­å¼€è¿æ¥

  **æ³¨æ„ï¼š** æŒ‡ç¤ºæ•°æ®åŒ…æ˜¯æœåŠ¡å™¨ä¸»åŠ¨å‘é€ç»™å®¢æˆ·ç«¯çš„ï¼Œä¸æ˜¯å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„å“åº”ã€‚


- å®¢æˆ·ç«¯åˆå§‹è¿è¡Œåæ˜¾ç¤ºçš„èœå•é€‰é¡¹

  å®¢æˆ·ç«¯é‡‡ç”¨ç°ä»£åŒ–ç»ˆç«¯ç•Œé¢è®¾è®¡ï¼Œä½¿ç”¨ANSIé¢œè‰²å¢å¼ºç”¨æˆ·ä½“éªŒã€‚

  **æœªè¿æ¥çŠ¶æ€èœå•ï¼š**

  ![alt text](image-2.png)

  **å·²è¿æ¥çŠ¶æ€èœå•ï¼š**
  
  ![alt text](image-3.png)



- å®¢æˆ·ç«¯çš„ä¸»çº¿ç¨‹å¾ªç¯å…³é”®ä»£ç æˆªå›¾ï¼ˆæè¿°æ€»ä½“ï¼Œçœç•¥ç»†èŠ‚éƒ¨åˆ†ï¼‰


  ```cpp
  int main(int argc, char* argv[]) {
      signal(SIGINT, exitHandler);  // æ³¨å†Œä¿¡å·å¤„ç†å™¨
      signal(SIGTERM, exitHandler);

      showBanner();

      // å¯åŠ¨æ¶ˆæ¯å‘ˆç°çº¿ç¨‹ï¼ˆè´Ÿè´£æ¸²æŸ“æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼‰
      std::thread presenterThread(messagePresenter);
      std::thread* receiverThread = nullptr;
      SocketWrapper* clientSocket = nullptr;

      while (!shouldExit) {
          showMenu();  // æ˜¾ç¤ºèœå•

          // è¯»å–ç”¨æˆ·è¾“å…¥
          std::string input;
          if (!std::getline(std::cin, input)) break;

          int choice = std::stoi(input);

          if (!isConnected) {
              // æœªè¿æ¥çŠ¶æ€ï¼šå¤„ç†è¿æ¥è¯·æ±‚
              if (choice == 1) {
                  // åˆ›å»ºsocketï¼Œè¿æ¥æœåŠ¡å™¨
                  int sockfd = socket(AF_INET, SOCK_STREAM, 0);
                  // ...è®¾ç½®æœåŠ¡å™¨åœ°å€...
                  connect(sockfd, ...);

                  clientSocket = new SocketWrapper(sockfd);
                  isConnected = true;

                  // å¯åŠ¨æ¥æ”¶çº¿ç¨‹
                  receiverThread = new std::thread(receiveMessages, clientSocket);
              }
          } else {
              // å·²è¿æ¥çŠ¶æ€ï¼šå¤„ç†å„ç§è¯·æ±‚
              switch (choice) {
                  case 1: // æ–­å¼€è¿æ¥
                      clientSocket->send(Packet(MessageType::REQ_DISCONNECT));
                      isConnected = false;
                      break;
                  case 2: // è·å–æ—¶é—´
                      clientSocket->send(Packet(MessageType::REQ_GET_TIME));
                      break;
                  case 3: // è·å–åç§°
                      clientSocket->send(Packet(MessageType::REQ_GET_NAME));
                      break;
                  case 4: // è·å–å®¢æˆ·ç«¯åˆ—è¡¨
                      clientSocket->send(Packet(MessageType::REQ_GET_CLIENTS));
                      break;
              }
          }
      }

      // é€€å‡ºæ¸…ç†
      if (receiverThread && receiverThread->joinable()) {
          receiverThread->join();
      }
      msgCondition.notify_all();
      if (presenterThread.joinable()) presenterThread.join();

      return 0;
  }
  ```

  - ä¸»çº¿ç¨‹è´Ÿè´£ç”¨æˆ·äº¤äº’å’Œå‘é€è¯·æ±‚
  - é‡‡ç”¨å¤šçº¿ç¨‹æ¶æ„ï¼šä¸»çº¿ç¨‹ + æ¥æ”¶çº¿ç¨‹ + æ¶ˆæ¯å‘ˆç°çº¿ç¨‹
  - ä½¿ç”¨å…¨å±€æ ‡å¿—`isConnected`ç®¡ç†è¿æ¥çŠ¶æ€
  - é€šè¿‡ä¿¡å·å¤„ç†å™¨å®ç°ä¼˜é›…é€€å‡º



- å®¢æˆ·ç«¯çš„æ¥æ”¶æ•°æ®å­çº¿ç¨‹å¾ªç¯å…³é”®ä»£ç æˆªå›¾ï¼ˆæè¿°æ€»ä½“ï¼Œçœç•¥ç»†èŠ‚éƒ¨åˆ†ï¼‰

  **æ¥æ”¶çº¿ç¨‹æ ¸å¿ƒé€»è¾‘**

  ```cpp
  void receiveMessages(SocketWrapper* sock) {
      while (!shouldExit && isConnected) {
          Packet pkt;

          // é˜»å¡æ¥æ”¶æ•°æ®åŒ…
          if (!sock->recv(pkt)) {
              if (!shouldExit) {
                  std::cout << "[!] é”™è¯¯ï¼šä¸æœåŠ¡å™¨çš„è¿æ¥å·²æ„å¤–ä¸­æ–­" << std::endl;
                  isConnected = false;
              }
              break;
          }

          // å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—
          {
              std::lock_guard<std::mutex> lock(msgMutex);
              msgQueue.push(pkt);
          }

          // é€šçŸ¥æ¶ˆæ¯å‘ˆç°çº¿ç¨‹å¤„ç†
          msgCondition.notify_all();
      }
  }
  ```

  **æ¶ˆæ¯å‘ˆç°çº¿ç¨‹æ ¸å¿ƒé€»è¾‘**

  ```cpp
  void messagePresenter() {
      while (!shouldExit) {
          std::unique_lock<std::mutex> lock(msgMutex);

          // ç­‰å¾…æ¶ˆæ¯é˜Ÿåˆ—éç©º
          msgCondition.wait(lock, []{ return !msgQueue.empty() || shouldExit; });

          while (!msgQueue.empty()) {
              Packet pkt = msgQueue.front();
              msgQueue.pop();
              lock.unlock();

              // æ ¹æ®æ¶ˆæ¯ç±»å‹ç€è‰²è¾“å‡º
              switch (pkt.getType()) {
                  case MessageType::RESP_CONNECT:
                      std::cout << "âœ” [Server] " << pkt.data << std::endl;
                      break;
                  case MessageType::RESP_TIME:
                      std::cout << "ğŸ•’ [Time] " << pkt.data << std::endl;
                      break;
                  case MessageType::RESP_NAME:
                      std::cout << "ğŸ· [Name] " << pkt.data << std::endl;
                      break;
                  case MessageType::RESP_CLIENTS:
                      std::cout << "ğŸ‘¥ [Client List]\n" << pkt.data << std::endl;
                      break;
                  // ...å…¶ä»–æ¶ˆæ¯ç±»å‹...
              }

              lock.lock();
          }
      }
  }
  ```

   - ä½¿ç”¨**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**ï¼šæ¥æ”¶çº¿ç¨‹ç”Ÿäº§æ¶ˆæ¯ï¼Œå‘ˆç°çº¿ç¨‹æ¶ˆè´¹æ¶ˆæ¯
   - ä½¿ç”¨**mutex + condition_variable**å®ç°çº¿ç¨‹åŒæ­¥
   - æ¥æ”¶çº¿ç¨‹ä¸“æ³¨äºç½‘ç»œI/Oï¼Œå‘ˆç°çº¿ç¨‹ä¸“æ³¨äºç•Œé¢æ˜¾ç¤ºï¼Œåˆ†å·¥æ˜ç¡®
   - é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ¥æ”¶å’Œæ˜¾ç¤ºé€»è¾‘



- æœåŠ¡å™¨åˆå§‹è¿è¡Œåæ˜¾ç¤ºçš„ç•Œé¢
 
![alt text](image.png)

  æœåŠ¡å™¨ç›‘å¬åœ¨4703ç«¯å£ï¼ˆä½¿ç”¨å­¦å·å4ä½ï¼‰ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ä¼šæ˜¾ç¤ºï¼š
  ```
  [HH:MM:SS] [CONN] Accepted new peer: 127.0.0.1:54321
  ```

  å½“å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¼šæ˜¾ç¤ºç›¸åº”çš„æ—¥å¿—ï¼š

  ![alt text](image-6.png)



- æœåŠ¡å™¨çš„ä¸»çº¿ç¨‹å¾ªç¯å…³é”®ä»£ç æˆªå›¾ï¼ˆæè¿°æ€»ä½“ï¼Œçœç•¥ç»†èŠ‚éƒ¨åˆ†ï¼‰

  **æœåŠ¡å™¨ä¸»çº¿ç¨‹æ ¸å¿ƒé€»è¾‘**

  ```cpp
  int main(int argc, char* argv[]) {
      signal(SIGINT, exitHandler);   // æ³¨å†Œä¿¡å·å¤„ç†å™¨
      signal(SIGTERM, exitHandler);

      showServerBanner();

      // 1. åˆ›å»ºsocket
      int serverSocket = socket(AF_INET, SOCK_STREAM, 0);

      // 2. è®¾ç½®åœ°å€é‡ç”¨é€‰é¡¹
      int opt = 1;
      setsockopt(serverSocket, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));

      // 3. ç»‘å®šåœ°å€å’Œç«¯å£
      struct sockaddr_in serverAddress;
      memset(&serverAddress, 0, sizeof(serverAddress));
      serverAddress.sin_family = AF_INET;
      serverAddress.sin_addr.s_addr = INADDR_ANY;
      serverAddress.sin_port = htons(SERVER_PORT);  // 4703

      bind(serverSocket, (struct sockaddr*)&serverAddress, sizeof(serverAddress));

      // 4. å¼€å§‹ç›‘å¬
      listen(serverSocket, MAX_CLIENT_QUEUE);  // é˜Ÿåˆ—é•¿åº¦20

      log("INIT", CYAN, "Orchestrator online. Listening for incoming sockets...");

      std::vector<std::thread> threads;

      // 5. ä¸»å¾ªç¯ï¼šæ¥å—å®¢æˆ·ç«¯è¿æ¥
      while (!shouldExit) {
          struct sockaddr_in clientAddress;
          socklen_t clientAddressLength = sizeof(clientAddress);

          // é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
          int clientSocket = accept(serverSocket,
                                    (struct sockaddr*)&clientAddress,
                                    &clientAddressLength);

          if (clientSocket < 0) {
              if (shouldExit) break;
              log("ERROR", RED, "Accept failed on kernel level.");
              continue;
          }

          // è·å–å®¢æˆ·ç«¯IPå’Œç«¯å£
          char clientIP[INET_ADDRSTRLEN];
          inet_ntop(AF_INET, &clientAddress.sin_addr, clientIP, INET_ADDRSTRLEN);
          std::string clientAddr = std::string(clientIP) + ":" +
                                   std::to_string(ntohs(clientAddress.sin_port));

          // ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºå¤„ç†çº¿ç¨‹
          threads.emplace_back(handleClient, clientSocket, clientAddr);

          // åˆ†ç¦»çº¿ç¨‹ï¼Œè®©å…¶ç‹¬ç«‹è¿è¡Œ
          threads.back().detach();
      }

      log("EXIT", WHITE, "Finalizing kernel resources... Goodbye.");
      close(serverSocket);
      return 0;
  }
  ```

   - ä½¿ç”¨æ ‡å‡†çš„**socket -> bind -> listen -> accept**æµç¨‹
   - ä¸»çº¿ç¨‹å¾ªç¯accept()ï¼Œæ¯æ¥å—ä¸€ä¸ªè¿æ¥å°±åˆ›å»ºæ–°çº¿ç¨‹å¤„ç†
   - ä½¿ç”¨**detach()**è®©å­çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œé¿å…ä¸»çº¿ç¨‹ç®¡ç†å‹åŠ›
   - é€šè¿‡å…¨å±€æ ‡å¿—`shouldExit`å®ç°ä¼˜é›…é€€å‡º
   - ä½¿ç”¨`SO_REUSEADDR`é€‰é¡¹é¿å…ç«¯å£å ç”¨é—®é¢˜



- æœåŠ¡å™¨çš„å®¢æˆ·ç«¯å¤„ç†å­çº¿ç¨‹å¾ªç¯å…³é”®ä»£ç æˆªå›¾ï¼ˆæè¿°æ€»ä½“ï¼Œçœç•¥ç»†èŠ‚éƒ¨åˆ†ï¼‰

  **å®¢æˆ·ç«¯å¤„ç†çº¿ç¨‹æ ¸å¿ƒé€»è¾‘**

  ```cpp
  void handleClient(int clientFd, std::string clientAddr) {
      SocketWrapper clientSock(clientFd);
      log("CONN", GREEN, "Accepted new peer: " + clientAddr);

      // å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨ï¼ˆéœ€è¦åŠ é”ï¼‰
      {
          std::lock_guard<std::mutex> lock(clientsMutex);
          connectedClients[clientFd] = clientAddr;
      }

      // å‘é€æ¬¢è¿æ¶ˆæ¯
      Packet welcomePkt(MessageType::RESP_CONNECT,
                        "Connected to Lab7-Advanced-Server v2.0");
      clientSock.send(welcomePkt);

      // ä¸»å¾ªç¯ï¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
      while (!shouldExit) {
          Packet request;

          // æ¥æ”¶è¯·æ±‚åŒ…
          if (!clientSock.recv(request)) break;

          Packet response;

          // æ ¹æ®è¯·æ±‚ç±»å‹åˆ†å‘å¤„ç†
          switch (request.getType()) {
              case MessageType::REQ_GET_TIME:
                  log("TASK", BLUE, "Query: TIME | Client: " + clientAddr);
                  response = Packet(MessageType::RESP_TIME, getCurrentTime());
                  clientSock.send(response);
                  break;

              case MessageType::REQ_GET_NAME:
                  log("TASK", BLUE, "Query: NAME | Client: " + clientAddr);
                  response = Packet(MessageType::RESP_NAME,
                                   "ZJU-BS-Experimental-Server-4703");
                  clientSock.send(response);
                  break;

              case MessageType::REQ_GET_CLIENTS:
                  log("TASK", BLUE, "Query: LIST | Client: " + clientAddr);
                  response = Packet(MessageType::RESP_CLIENTS, getClientList());
                  clientSock.send(response);
                  break;

              case MessageType::REQ_DISCONNECT:
                  log("CONN", YELLOW, "Peer requested termination: " + clientAddr);
                  goto cleanup;

              default:
                  log("WARN", MAGENTA, "Unknown opcode from " + clientAddr);
                  break;
          }
      }

  cleanup:
      // æ¸…ç†ï¼šä»å®¢æˆ·ç«¯åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆéœ€è¦åŠ é”ï¼‰
      {
          std::lock_guard<std::mutex> lock(clientsMutex);
          connectedClients.erase(clientFd);
      }
      log("CONN", RED, "Peer disconnected: " + clientAddr);
  }
  ```

  **è¾…åŠ©å‡½æ•°ï¼š**

  ```cpp
  // è·å–å½“å‰æ—¶é—´
  std::string getCurrentTime() {
      time_t now = time(nullptr);
      char buf[64];
      strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
      return std::string(buf);
  }

  // è·å–å®¢æˆ·ç«¯åˆ—è¡¨
  std::string getClientList() {
      std::lock_guard<std::mutex> lock(clientsMutex);
      std::string result;
      int index = 1;
      for (const auto& [fd, addr] : connectedClients) {
          result += std::to_string(index++) + ". " + addr + " (Active)\n";
      }
      return result.empty() ? "No active connections." : result;
  }
  ```

   - æ¯ä¸ªå®¢æˆ·ç«¯ç”±ç‹¬ç«‹çº¿ç¨‹å¤„ç†ï¼Œäº’ä¸å¹²æ‰°
   - ä½¿ç”¨**mutex**ä¿æŠ¤å…±äº«æ•°æ®ç»“æ„`connectedClients`
   - é‡‡ç”¨**SocketWrapper RAIIå°è£…**ï¼Œè‡ªåŠ¨ç®¡ç†socketç”Ÿå‘½å‘¨æœŸ
   - ä½¿ç”¨**switch-case**åˆ†å‘ä¸åŒç±»å‹çš„è¯·æ±‚
   - é€šè¿‡gotoå®ç°ä¼˜é›…çš„æ¸…ç†æµç¨‹



- å®¢æˆ·ç«¯é€‰æ‹©è¿æ¥åŠŸèƒ½æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¾ç¤ºå†…å®¹æˆªå›¾ã€‚

  - æœåŠ¡å™¨
  ![alt text](image-13.png) // TODO

  - å®¢æˆ·ç«¯
  ![alt text](test-1-c.png) 

  - WiresharkæŠ“å–çš„æ•°æ®åŒ…æˆªå›¾ï¼š

  ![alt text](test-1-w.png)

- å®¢æˆ·ç«¯é€‰æ‹©è·å–æ—¶é—´åŠŸèƒ½æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¾ç¤ºå†…å®¹æˆªå›¾ã€‚

  - æœåŠ¡å™¨ï¼š
  ![alt text](image-16.png) // TODO
  - å®¢æˆ·ç«¯ï¼š
  ![alt text](test-2-c.png) 
  - WiresharkæŠ“å–çš„æ•°æ®åŒ…æˆªå›¾ï¼ˆå±•å¼€åº”ç”¨å±‚æ•°æ®åŒ…ï¼Œæ ‡è®°è¯·æ±‚ã€å“åº”ç±»å‹ã€è¿”å›çš„æ—¶é—´æ•°æ®å¯¹åº”çš„ä½ç½®ï¼‰ï¼š
    - è¯·æ±‚æ•°æ®åŒ…ï¼š![alt text](test-2-w1.png)
    - å“åº”æ•°æ®åŒ…ï¼š![alt text](test-2-w2.png)
  

- å®¢æˆ·ç«¯é€‰æ‹©è·å–åå­—åŠŸèƒ½æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¾ç¤ºå†…å®¹æˆªå›¾ã€‚


  - æœåŠ¡å™¨ï¼š
  ![alt text](image-17.png) // TODO
  - å®¢æˆ·ç«¯ï¼š
  ![alt text](test-3-c.png)

  - WiresharkæŠ“å–çš„æ•°æ®åŒ…æˆªå›¾ï¼ˆå±•å¼€åº”ç”¨å±‚æ•°æ®åŒ…ï¼Œæ ‡è®°è¯·æ±‚ã€å“åº”ç±»å‹ã€è¿”å›çš„åå­—æ•°æ®å¯¹åº”çš„ä½ç½®ï¼‰ï¼š
    - è¯·æ±‚æ•°æ®åŒ…ï¼š![alt text](test-3-w1.png)
    - å“åº”æ•°æ®åŒ…ï¼š![alt text](test-3-w2.png)    
  
  ç›¸å…³çš„æœåŠ¡å™¨çš„å¤„ç†ä»£ç ç‰‡æ®µï¼š// TODO

  
- å®¢æˆ·ç«¯é€‰æ‹©è·å–å®¢æˆ·ç«¯åˆ—è¡¨åŠŸèƒ½æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¾ç¤ºå†…å®¹æˆªå›¾ã€‚

  - æœåŠ¡å™¨ï¼š
  ![alt text](image-18.png)  // TODO
  - å®¢æˆ·ç«¯ï¼š
  ![alt text](test-4-c.png)
  WiresharkæŠ“å–çš„æ•°æ®åŒ…æˆªå›¾ï¼ˆå±•å¼€åº”ç”¨å±‚æ•°æ®åŒ…ï¼Œæ ‡è®°è¯·æ±‚ã€å“åº”ç±»å‹ã€è¿”å›çš„å®¢æˆ·ç«¯åˆ—è¡¨æ•°æ®å¯¹åº”çš„ä½ç½®ï¼‰ï¼š
    - è¯·æ±‚æ•°æ®åŒ…ï¼š![alt text](test-4-w1.png)
    - å“åº”æ•°æ®åŒ…ï¼š![alt text](test-4-w2.png) 
  
  ç›¸å…³çš„æœåŠ¡å™¨çš„å¤„ç†ä»£ç ç‰‡æ®µï¼š // TODO

  
- å®¢æˆ·ç«¯é€‰æ‹©å‘é€æ¶ˆæ¯åŠŸèƒ½æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¾ç¤ºå†…å®¹æˆªå›¾ã€‚

  å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼š
  ![alt text](test-5-c.png)
  
  æœåŠ¡å™¨ï¼š

  ![alt text](image-19.png) // TODO

  æ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼š

  ![alt text](image-9.png) // TODO

  WiresharkæŠ“å–çš„æ•°æ®åŒ…æˆªå›¾ï¼ˆå‘é€å’Œæ¥æ”¶åˆ†åˆ«æ ‡è®°ï¼‰ï¼š
    - è¯·æ±‚æ•°æ®åŒ…ï¼š![alt text](test-5-w1.png)
    - å“åº”æ•°æ®åŒ…ï¼š![alt text](test-5-w2.png) 
  
  ç›¸å…³çš„æœåŠ¡å™¨çš„å¤„ç†ä»£ç ç‰‡æ®µï¼š // TODO

  

  ç›¸å…³çš„å®¢æˆ·ç«¯ï¼ˆå‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼‰å¤„ç†ä»£ç ç‰‡æ®µï¼š // TODO

  

- æ‹”æ‰å®¢æˆ·ç«¯çš„ç½‘çº¿ï¼Œç„¶åé€€å‡ºå®¢æˆ·ç«¯ç¨‹åºã€‚

  è§‚å¯Ÿå®¢æˆ·ç«¯çš„TCPè¿æ¥çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨Wiresharkè§‚å¯Ÿå®¢æˆ·ç«¯æ˜¯å¦å‘å‡ºäº†TCPè¿æ¥é‡Šæ”¾çš„æ¶ˆæ¯ã€‚åŒæ—¶è§‚å¯ŸæœåŠ¡ç«¯çš„TCPè¿æ¥çŠ¶æ€åœ¨è¾ƒé•¿æ—¶é—´å†…ï¼ˆ10åˆ†é’Ÿä»¥ä¸Šï¼‰æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚

  ![alt text](test-6.png) 
  

- å†æ¬¡è¿ä¸Šå®¢æˆ·ç«¯çš„ç½‘çº¿ï¼Œé‡æ–°è¿è¡Œå®¢æˆ·ç«¯ç¨‹åºã€‚

  é€‰æ‹©è¿æ¥åŠŸèƒ½ï¼Œè¿ä¸Šåé€‰æ‹©è·å–å®¢æˆ·ç«¯åˆ—è¡¨åŠŸèƒ½ï¼ŒæŸ¥çœ‹ä¹‹å‰å¼‚å¸¸é€€å‡ºçš„è¿æ¥æ˜¯å¦è¿˜åœ¨ã€‚é€‰æ‹©ç»™è¿™ä¸ªä¹‹å‰å¼‚å¸¸é€€å‡ºçš„å®¢æˆ·ç«¯è¿æ¥å‘é€æ¶ˆæ¯ï¼Œå‡ºç°äº†ä»€ä¹ˆæƒ…å†µï¼Ÿ

  ![alt text](test-7.png) 

  **å®éªŒç°è±¡ï¼š**

  1. **ä¹‹å‰å¼‚å¸¸é€€å‡ºçš„è¿æ¥ä»ç„¶å­˜åœ¨äºå®¢æˆ·ç«¯åˆ—è¡¨ä¸­**
     - æœåŠ¡å™¨çš„connectedClientsæ˜ å°„ä¸­ä»ä¿ç•™ç€æ–­ç½‘å®¢æˆ·ç«¯çš„è®°å½•
     - å®¢æˆ·ç«¯åˆ—è¡¨ä¼šæ˜¾ç¤ºè¯¥å®¢æˆ·ç«¯ï¼ˆä½†å®é™…ä¸Šå·²ç»æ–­å¼€ï¼‰

  2. **å°è¯•å‘é€æ¶ˆæ¯æ—¶çš„æƒ…å†µï¼š**
     - å®¢æˆ·ç«¯è¾“å…¥ç¼–å·å’Œæ¶ˆæ¯å†…å®¹åï¼Œæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨
     - æœåŠ¡å™¨å°è¯•å‘ç›®æ ‡å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨`send()`
     - **ç¬¬ä¸€æ¬¡å‘é€å¯èƒ½æˆåŠŸ**ï¼ˆå› ä¸ºTCPå‘é€ç¼“å†²åŒºæ¥å—äº†æ•°æ®ï¼‰
     - ä½†å®é™…ä¸Šæ¶ˆæ¯æ— æ³•é€è¾¾ï¼Œå› ä¸ºè¿æ¥å·²æ–­å¼€
     - æœåŠ¡å™¨å¯èƒ½åœ¨åç»­çš„å‘é€æ“ä½œä¸­æ‰ä¼šæ”¶åˆ°é”™è¯¯ï¼ˆEPIPEæˆ–ECONNRESETï¼‰
     - æ­¤æ—¶æœåŠ¡å™¨è¿”å›"Success"æ¶ˆæ¯ï¼Œä½†å®é™…ä¸Šç›®æ ‡å®¢æˆ·ç«¯æ”¶ä¸åˆ°

  **é—®é¢˜æ ¹æºï¼š**
  - TCPçš„åŠå…³é—­ç‰¹æ€§ï¼šå•æ–¹é¢æ–­ç½‘ä¸ä¼šç«‹å³é€šçŸ¥å¯¹ç«¯
  - æœåŠ¡å™¨æ²¡æœ‰å®ç°è¿æ¥å¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆå¦‚Keep-Aliveæˆ–å¿ƒè·³ï¼‰
  - `send()`è°ƒç”¨æˆåŠŸåªè¡¨ç¤ºæ•°æ®æ”¾å…¥å‘é€ç¼“å†²åŒºï¼Œä¸ä»£è¡¨å¯¹ç«¯æ”¶åˆ°

  **æ”¹è¿›å»ºè®®ï¼š**
  - å®ç°TCP Keep-Aliveæœºåˆ¶è‡ªåŠ¨æ£€æµ‹æ­»è¿æ¥
  - å®ç°åº”ç”¨å±‚å¿ƒè·³æœºåˆ¶
  - åœ¨æ¶ˆæ¯è½¬å‘æ—¶æ£€æŸ¥send()çš„è¿”å›å€¼ï¼Œå¦‚æœå¤±è´¥åˆ™ä»åˆ—è¡¨ä¸­ç§»é™¤è¯¥å®¢æˆ·ç«¯

- ä¿®æ”¹è·å–æ—¶é—´åŠŸèƒ½ï¼Œæ”¹ä¸ºç”¨æˆ·é€‰æ‹©1æ¬¡ï¼Œç¨‹åºå†…è‡ªåŠ¨å‘é€100æ¬¡è¯·æ±‚ã€‚

  æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¤„ç†äº†100æ¬¡è¯·æ±‚ï¼Œæˆªå–å®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”ï¼ˆé€šè¿‡ç¨‹åºè®¡æ•°ä¸€ä¸‹æ˜¯å¦æœ‰100ä¸ªå“åº”å›æ¥ï¼‰ï¼Œå¹¶ä½¿ç”¨WiresharkæŠ“å–æ•°æ®åŒ…ï¼Œè§‚å¯Ÿå®é™…å‘å‡ºçš„æ•°æ®åŒ…ä¸ªæ•°ã€‚

  ![alt text](test-8-c.png) 
  ![alt text](test-8-w.png) 

  **å®éªŒç»“æœï¼š**

  **å®¢æˆ·ç«¯ç»Ÿè®¡æ˜¾ç¤ºï¼š**
  ```
  ========== ç»Ÿè®¡ç»“æœ ==========
   å‘é€è¯·æ±‚æ•°: 100
   æ”¶åˆ°å“åº”æ•°: 100
   âœ“ æ‰€æœ‰å“åº”å‡å·²æ”¶åˆ°ï¼
  =============================
  ```

  **æœåŠ¡å™¨å¤„ç†æƒ…å†µï¼š**
  - æœåŠ¡å™¨æ­£å¸¸å¤„ç†äº†æ‰€æœ‰100æ¬¡è¯·æ±‚
  - æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º100æ¬¡"Query: TIME"è®°å½•
  - æ¯æ¬¡è¯·æ±‚éƒ½æ­£ç¡®è¿”å›äº†å½“å‰æ—¶é—´

  **WiresharkæŠ“åŒ…åˆ†æï¼š**

  1. **åº”ç”¨å±‚æ•°æ®åŒ…æ•°é‡ï¼š**
     - å®¢æˆ·ç«¯å‘é€çš„åº”ç”¨å±‚è¯·æ±‚åŒ…ï¼šè¿œå°‘äº100ä¸ªï¼ˆç”±äºTCPåˆå¹¶ï¼‰
     - æœåŠ¡å™¨è¿”å›çš„åº”ç”¨å±‚å“åº”åŒ…ï¼šè¿œå°‘äº100ä¸ªï¼ˆç”±äºTCPåˆå¹¶ï¼‰
     - å®é™…TCP Segmentæ•°é‡ï¼šçº¦10-20ä¸ªï¼ˆå–å†³äºç½‘ç»œçŠ¶å†µå’ŒNagleç®—æ³•ï¼‰

  2. **TCPåˆå¹¶ç°è±¡ï¼š**
     - ç”±äºå®¢æˆ·ç«¯å¿«é€Ÿè¿ç»­å‘é€100æ¬¡è¯·æ±‚ï¼ŒTCPçš„Nagleç®—æ³•å°†å¤šä¸ªå°çš„åº”ç”¨å±‚æ•°æ®åŒ…åˆå¹¶
     - ä¸€ä¸ªTCP Segmentå¯èƒ½åŒ…å«å¤šä¸ªæ—¶é—´è¯·æ±‚åŒ…
     - æœåŠ¡å™¨çš„å“åº”ä¹Ÿè¢«åˆå¹¶åˆ°å°‘é‡çš„TCP Segmentä¸­

  3. **åŒ…å¤§å°åˆ†æï¼š**
     - å•ä¸ªè¯·æ±‚åŒ…å¤§å°ï¼š7å­—èŠ‚ï¼ˆHeaderï¼‰+ 0å­—èŠ‚ï¼ˆDataï¼‰= 7å­—èŠ‚
     - 100ä¸ªè¯·æ±‚æ€»è®¡ï¼š700å­—èŠ‚
     - å®é™…å¯èƒ½è¢«åˆå¹¶æˆ2-5ä¸ªTCP Segmentå‘é€

  **ç»“è®ºï¼š**
  - **åº”ç”¨å±‚**ï¼šå®¢æˆ·ç«¯æˆåŠŸå‘é€100æ¬¡è¯·æ±‚ï¼Œæ”¶åˆ°100æ¬¡å“åº”ï¼Œæ•°æ®å®Œæ•´
  - **ä¼ è¾“å±‚**ï¼šTCPå°†å¤šä¸ªåº”ç”¨å±‚åŒ…åˆå¹¶ï¼Œå®é™…TCP Segmentæ•°è¿œå°äº100
  - è¿™éªŒè¯äº†ä¹‹å‰å…³äºsend()æ¬¡æ•°ä¸TCP Segmentä¸ä¸€è‡´çš„åˆ†æ

  ```cpp
  case 2: { // è·å–æ—¶é—´
      std::cout << "æ˜¯å¦æ‰¹é‡å‘é€100æ¬¡è¯·æ±‚? (y/n) [n]: ";
      std::string batchInput;
      std::getline(std::cin, batchInput);

      if (batchInput == "y" || batchInput == "Y") {
          isBatchTimeRequest = true;
          timeResponseCount = 0;

          for (int i = 0; i < 100; i++) {
              clientSocket->send(Packet(MessageType::REQ_GET_TIME));
          }

          std::this_thread::sleep_for(std::chrono::seconds(5));

          std::cout << "å‘é€è¯·æ±‚æ•°: 100" << std::endl;
          std::cout << "æ”¶åˆ°å“åº”æ•°: " << timeResponseCount << std::endl;
      }
  }
  ```



- å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥æœåŠ¡å™¨ï¼ŒåŒæ—¶å‘é€æ—¶é—´è¯·æ±‚ï¼ˆç¨‹åºå†…è‡ªåŠ¨è¿ç»­è°ƒç”¨100æ¬¡sendï¼‰ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„è¿è¡Œæˆªå›¾

  ![alt text](test-8-c.png) 
  // TODO æœåŠ¡å™¨

## å…­ã€å®éªŒç»“æœä¸åˆ†æ

æ ¹æ®ä½ ç¼–å†™çš„ç¨‹åºè¿è¡Œæ•ˆæœï¼Œåˆ†åˆ«è§£ç­”ä»¥ä¸‹é—®é¢˜ï¼š

- å®¢æˆ·ç«¯æ˜¯å¦éœ€è¦è°ƒç”¨bindæ“ä½œï¼Ÿå®ƒçš„æºç«¯å£æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿæ¯ä¸€æ¬¡è°ƒç”¨connectæ—¶å®¢æˆ·ç«¯çš„ç«¯å£æ˜¯å¦éƒ½ä¿æŒä¸å˜ï¼Ÿ

  **ç­”ï¼š**

  å®¢æˆ·ç«¯**ä¸éœ€è¦**æ˜¾å¼è°ƒç”¨`bind()`æ“ä½œã€‚

  **æºç«¯å£äº§ç”Ÿæœºåˆ¶ï¼š**
  - å½“å®¢æˆ·ç«¯è°ƒç”¨`connect()`æ—¶ï¼Œå¦‚æœæ²¡æœ‰äº‹å…ˆè°ƒç”¨`bind()`ç»‘å®šæœ¬åœ°ç«¯å£ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºè¯¥socketåˆ†é…ä¸€ä¸ªä¸´æ—¶ç«¯å£ï¼ˆephemeral portï¼‰
  - ä¸´æ—¶ç«¯å£çš„èŒƒå›´é€šå¸¸åœ¨32768-60999ä¹‹é—´ï¼ˆå¯é€šè¿‡`cat /proc/sys/net/ipv4/ip_local_port_range`æŸ¥çœ‹ï¼‰
  - æ“ä½œç³»ç»Ÿä¼šä»å¯ç”¨ç«¯å£æ± ä¸­é€‰æ‹©ä¸€ä¸ªæœªè¢«å ç”¨çš„ç«¯å£

  **æ¯æ¬¡connectçš„ç«¯å£æ˜¯å¦ä¸å˜ï¼š**
  - **ä¸ä¿æŒä¸å˜**ã€‚æ¯æ¬¡é‡æ–°åˆ›å»ºsocketå¹¶è°ƒç”¨`connect()`æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…æ–°çš„ä¸´æ—¶ç«¯å£
  - åªæœ‰å½“socketä¿æŒæ‰“å¼€çŠ¶æ€æ—¶ï¼Œæºç«¯å£æ‰ä¸ä¼šå˜åŒ–
  - å¦‚æœå…³é—­socketåé‡æ–°è¿æ¥ï¼Œç«¯å£å·ä¼šæ”¹å˜ï¼ˆé™¤éä¸Šä¸€ä¸ªç«¯å£è¿˜æœªå®Œå…¨é‡Šæ”¾ï¼Œå¯èƒ½è¢«é‡ç”¨ï¼‰

  **æœ¬å®éªŒä¸­çš„ä½“ç°ï¼š**
  ä»client.cpp:190-211å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡è¿æ¥æ—¶éƒ½åˆ›å»ºæ–°çš„socketï¼Œå› æ­¤æ¯æ¬¡è¿æ¥çš„æºç«¯å£éƒ½æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„æ–°ç«¯å£ã€‚



- å‡è®¾åœ¨æœåŠ¡ç«¯è°ƒç”¨listenå’Œè°ƒç”¨acceptä¹‹é—´è®¾äº†ä¸€ä¸ªè°ƒè¯•æ–­ç‚¹ï¼Œæš‚åœåœ¨æ­¤æ–­ç‚¹æ—¶ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯è°ƒç”¨connectåæ˜¯å¦é©¬ä¸Šèƒ½è¿æ¥æˆåŠŸï¼Ÿ

  **ç­”ï¼š**

  å®¢æˆ·ç«¯è°ƒç”¨`connect()`**å¯ä»¥ç«‹å³æˆåŠŸ**ï¼Œå³ä½¿æœåŠ¡ç«¯æš‚åœåœ¨listenå’Œacceptä¹‹é—´ã€‚

  **åŸç†è§£é‡Šï¼š**
  1. `listen()`å‡½æ•°çš„ä½œç”¨æ˜¯å°†socketè®¾ç½®ä¸ºè¢«åŠ¨ç›‘å¬æ¨¡å¼ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª**è¿æ¥ç­‰å¾…é˜Ÿåˆ—**ï¼ˆæœ¬å®éªŒä¸­é˜Ÿåˆ—é•¿åº¦ä¸º20ï¼Œè§server.cpp:166ï¼‰
  2. å½“å®¢æˆ·ç«¯è°ƒç”¨`connect()`å‘èµ·TCPä¸‰æ¬¡æ¡æ‰‹æ—¶ï¼š
     - å®¢æˆ·ç«¯å‘é€SYNåŒ…
     - æœåŠ¡ç«¯å†…æ ¸è‡ªåŠ¨å›å¤SYN+ACKåŒ…
     - å®¢æˆ·ç«¯å‘é€ACKåŒ…å®Œæˆæ¡æ‰‹
  3. **ä¸‰æ¬¡æ¡æ‰‹ç”±æ“ä½œç³»ç»Ÿå†…æ ¸è‡ªåŠ¨å®Œæˆ**ï¼Œä¸éœ€è¦åº”ç”¨ç¨‹åºï¼ˆæœåŠ¡ç«¯è¿›ç¨‹ï¼‰å‚ä¸
  4. æ¡æ‰‹å®Œæˆåï¼Œå·²å»ºç«‹çš„è¿æ¥ä¼šè¢«æ”¾å…¥**å·²å®Œæˆè¿æ¥é˜Ÿåˆ—**ï¼ˆaccepté˜Ÿåˆ—ï¼‰
  5. `accept()`çš„ä½œç”¨åªæ˜¯ä»å·²å®Œæˆé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™é˜»å¡ç­‰å¾…

  **ç»“è®ºï¼š**
  - åªè¦è¿æ¥é˜Ÿåˆ—æœªæ»¡ï¼Œå®¢æˆ·ç«¯çš„`connect()`å°±èƒ½æˆåŠŸ
  - æœåŠ¡ç«¯è¿›ç¨‹å¯ä»¥ç¨åè°ƒç”¨`accept()`æ¥å–å‡ºè¿™ä¸ªå·²å»ºç«‹çš„è¿æ¥
  - è¿™ç§æœºåˆ¶ä½¿å¾—æœåŠ¡å™¨å³ä½¿æš‚æ—¶ç¹å¿™ï¼Œä¹Ÿèƒ½ç¼“å†²ä¸€å®šæ•°é‡çš„è¿æ¥è¯·æ±‚



-   è¿ç»­å¿«é€Ÿsendå¤šæ¬¡æ•°æ®åï¼Œé€šè¿‡WiresharkæŠ“åŒ…çœ‹åˆ°çš„å‘é€çš„Tcp Segmentæ¬¡æ•°æ˜¯å¦å’Œsendçš„æ¬¡æ•°å®Œå…¨ä¸€è‡´ï¼Ÿ

    **ç­”ï¼š**

    **ä¸ä¸€å®šä¸€è‡´**ï¼Œå®é™…çš„TCP Segmentæ•°é‡é€šå¸¸**å°‘äº**`send()`è°ƒç”¨æ¬¡æ•°ã€‚

    **åŸå› åˆ†æï¼š**

    1. **Nagleç®—æ³•**ï¼š
       - TCPé»˜è®¤å¯ç”¨Nagleç®—æ³•ï¼Œè¯¥ç®—æ³•ä¼šå°†å¤šä¸ªå°çš„æ•°æ®åŒ…åˆå¹¶æˆä¸€ä¸ªè¾ƒå¤§çš„TCPæ®µå‘é€
       - ç›®çš„æ˜¯å‡å°‘ç½‘ç»œä¸­çš„å°åŒ…æ•°é‡ï¼Œæé«˜ç½‘ç»œåˆ©ç”¨ç‡
       - åªæœ‰å½“ç´¯ç§¯æ•°æ®è¾¾åˆ°MSSï¼ˆæœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ï¼‰æˆ–æ”¶åˆ°å‰ä¸€ä¸ªåŒ…çš„ACKæ—¶æ‰å‘é€

    2. **TCPç¼“å†²åŒºæœºåˆ¶**ï¼š
       - `send()`åªæ˜¯å°†æ•°æ®æ”¾å…¥å‘é€ç¼“å†²åŒºï¼Œä¸ä¸€å®šç«‹å³å‘é€
       - TCPåè®®æ ˆä¼šæ ¹æ®æ‹¥å¡æ§åˆ¶ã€æ»‘åŠ¨çª—å£ç­‰æœºåˆ¶å†³å®šä½•æ—¶å‘é€ä»¥åŠå‘é€å¤šå°‘æ•°æ®

    3. **å¯èƒ½çš„æƒ…å†µ**ï¼š
       - è¿ç»­å¿«é€Ÿè°ƒç”¨å¤šæ¬¡`send()`å‘é€å°æ•°æ®åŒ… â†’ è¢«åˆå¹¶æˆä¸€ä¸ªTCPæ®µ
       - å‘é€å¤§æ•°æ® â†’ å¯èƒ½è¢«æ‹†åˆ†æˆå¤šä¸ªTCPæ®µï¼ˆæ ¹æ®MSSï¼‰
       - å‘é€é€Ÿåº¦æ…¢ â†’ sendæ¬¡æ•°å’ŒTCPæ®µæ•°å¯èƒ½æ¥è¿‘

    **æœ¬å®éªŒéªŒè¯**ï¼š
    å¯ä»¥é€šè¿‡ä¿®æ”¹è·å–æ—¶é—´åŠŸèƒ½ï¼Œè¿ç»­å‘é€100æ¬¡è¯·æ±‚ï¼Œè§‚å¯ŸWiresharkä¸­å®é™…çš„TCPæ®µæ•°é‡ä¼šæ˜æ˜¾å°‘äº100ä¸ªã€‚

    **å¦‚ä½•å¼ºåˆ¶ä¸€å¯¹ä¸€**ï¼š
    å¦‚æœéœ€è¦æ¯æ¬¡sendå¯¹åº”ä¸€ä¸ªTCPæ®µï¼Œå¯ä»¥è®¾ç½®`TCP_NODELAY`é€‰é¡¹ç¦ç”¨Nagleç®—æ³•ï¼š
    ```cpp
    int flag = 1;
    setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, &flag, sizeof(flag));
    ```


    
- æœåŠ¡å™¨åœ¨åŒä¸€ä¸ªç«¯å£æ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå¦‚ä½•èƒ½åŒºåˆ†æ•°æ®åŒ…æ˜¯å±äºå“ªä¸ªå®¢æˆ·ç«¯çš„ï¼Ÿ

  

- å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥åï¼Œå½“æ—¶çš„TCPè¿æ¥çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ªçŠ¶æ€ä¿æŒäº†å¤šä¹…ï¼Ÿï¼ˆå¯ä»¥ä½¿ç”¨`netstat -an`æŸ¥çœ‹ï¼‰
    
    
    
- å®¢æˆ·ç«¯æ–­ç½‘åå¼‚å¸¸é€€å‡ºï¼ŒæœåŠ¡å™¨çš„TCPè¿æ¥çŠ¶æ€æœ‰ä»€ä¹ˆå˜åŒ–å—ï¼ŸæœåŠ¡å™¨è¯¥å¦‚ä½•æ£€æµ‹è¿æ¥æ˜¯å¦ç»§ç»­æœ‰æ•ˆï¼Ÿ

  

## ä¸ƒã€è®¨è®ºã€å¿ƒå¾—

å®éªŒè¿‡ç¨‹ä¸­é‡åˆ°çš„å›°éš¾ï¼Œå¾—åˆ°çš„ç»éªŒæ•™è®­ï¼Œå¯¹æœ¬å®éªŒå®‰æ’çš„æ›´å¥½å»ºè®®

